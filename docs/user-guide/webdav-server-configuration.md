# WebDAV 服务器配置指南

本指南将帮助您在 LightSync 中配置和管理 WebDAV 服务器连接。

## 目录

- [什么是 WebDAV](#什么是-webdav)
- [添加服务器](#添加服务器)
- [测试连接](#测试连接)
- [编辑服务器](#编辑服务器)
- [删除服务器](#删除服务器)
- [常见 WebDAV 服务商配置](#常见-webdav-服务商配置)
- [常见问题](#常见问题)
- [故障排除](#故障排除)

---

## 什么是 WebDAV

WebDAV (Web Distributed Authoring and Versioning) 是一种基于 HTTP 的协议，允许用户通过网络访问和管理文件。许多云存储服务（如 Nextcloud、ownCloud、坚果云等）都支持 WebDAV 协议。

LightSync 使用 WebDAV 协议与您的云存储服务器通信，实现文件的上传、下载和同步。

---

## 添加服务器

### 步骤

1. **打开服务器管理页面**
   - 在 LightSync 主界面，点击左侧导航栏的"服务器"选项

2. **点击"添加服务器"按钮**
   - 在服务器列表页面右上角，点击"添加服务器"按钮

3. **填写服务器信息**
   - **服务器名称**: 为服务器起一个便于识别的名称（如"我的 Nextcloud"）
   - **服务器 URL**: 输入 WebDAV 服务器的完整 URL
   - **用户名**: 输入您的账户用户名
   - **密码**: 输入您的账户密码
   - **使用 HTTPS**: 建议开启以保护数据传输安全
   - **超时时间**: 设置连接超时时间（默认 30 秒）

4. **保存配置**
   - 点击"保存"按钮完成添加

### 字段说明

#### 服务器名称

- **必填项**
- 用于在 LightSync 中识别服务器
- 可以使用中文或英文
- 示例：`我的 Nextcloud`、`公司云盘`

#### 服务器 URL

- **必填项**
- 必须包含协议（`http://` 或 `https://`）
- 必须是完整的 WebDAV 路径
- 示例：
  - Nextcloud: `https://cloud.example.com/remote.php/dav/files/username/`
  - ownCloud: `https://cloud.example.com/remote.php/webdav/`
  - 坚果云: `https://dav.jianguoyun.com/dav/`

#### 用户名

- **必填项**
- 您的 WebDAV 账户用户名
- 某些服务可能使用邮箱作为用户名

#### 密码

- **必填项**
- 您的 WebDAV 账户密码
- 密码将安全存储在系统密钥环中，不会以明文形式保存

#### 使用 HTTPS

- **推荐开启**
- 使用 HTTPS 可以加密传输数据，保护您的隐私
- 如果服务器不支持 HTTPS，可以关闭此选项

#### 超时时间

- **默认 30 秒**
- 有效范围：1-300 秒
- 如果网络较慢，可以适当增加超时时间
- 如果网络较快，可以减少超时时间以更快发现连接问题

---

## 测试连接

添加服务器后，建议立即测试连接以确保配置正确。

### 步骤

1. 在服务器列表中找到您的服务器
2. 点击服务器卡片上的"测试连接"按钮
3. 等待测试完成（通常需要几秒钟）
4. 查看测试结果：
   - ✅ **成功**: 显示绿色图标和"已连接"状态
   - ❌ **失败**: 显示红色图标和错误信息

### 测试结果说明

#### 连接成功

- 服务器状态显示为"已连接"
- 显示服务器类型（如 Nextcloud、ownCloud 或 Generic）
- 显示最后测试时间

#### 连接失败

- 服务器状态显示为"连接失败"
- 显示具体的错误信息
- 请根据错误信息进行故障排除（参见[故障排除](#故障排除)部分）

---

## 编辑服务器

如果需要修改服务器配置，可以使用编辑功能。

### 步骤

1. 在服务器列表中找到要编辑的服务器
2. 点击服务器卡片上的"编辑"按钮
3. 修改需要更改的字段
4. 点击"保存"按钮

### 注意事项

- **密码字段**: 编辑时密码字段显示为占位符（`••••••••`）
  - 如果不修改密码，请保持密码字段为空
  - 如果需要更新密码，请输入新密码
- **URL 修改**: 修改 URL 后建议重新测试连接
- **立即生效**: 配置修改后立即生效，无需重启应用

---

## 删除服务器

如果不再需要某个服务器，可以将其删除。

### 步骤

1. 在服务器列表中找到要删除的服务器
2. 点击服务器卡片上的"删除"按钮
3. 在确认对话框中点击"确定"

### 删除保护

**重要**: 如果服务器正在被任何同步文件夹使用，删除操作将被阻止。

删除保护的原因：

- 防止意外删除正在使用的服务器
- 避免同步文件夹失去连接
- 保护您的数据安全

如果需要删除正在使用的服务器：

1. 首先删除或修改所有使用该服务器的同步文件夹
2. 然后再删除服务器

### 删除后的影响

- 服务器配置从数据库中删除
- 密码从系统密钥环中删除
- 所有相关数据被清理
- **不可恢复**: 删除操作不可撤销，请谨慎操作

---

## 常见 WebDAV 服务商配置

### Nextcloud

**服务器 URL 格式**:

```
https://your-domain.com/remote.php/dav/files/username/
```

**配置示例**:

- 服务器名称: `我的 Nextcloud`
- 服务器 URL: `https://cloud.example.com/remote.php/dav/files/john/`
- 用户名: `john`
- 密码: `your-password`
- 使用 HTTPS: ✅ 是
- 超时时间: `30` 秒

**注意事项**:

- URL 末尾的 `username` 需要替换为您的实际用户名
- 某些 Nextcloud 实例可能使用不同的路径，请咨询您的管理员

---

### ownCloud

**服务器 URL 格式**:

```
https://your-domain.com/remote.php/webdav/
```

**配置示例**:

- 服务器名称: `我的 ownCloud`
- 服务器 URL: `https://cloud.example.com/remote.php/webdav/`
- 用户名: `john`
- 密码: `your-password`
- 使用 HTTPS: ✅ 是
- 超时时间: `30` 秒

---

### 坚果云

**服务器 URL 格式**:

```
https://dav.jianguoyun.com/dav/
```

**配置示例**:

- 服务器名称: `坚果云`
- 服务器 URL: `https://dav.jianguoyun.com/dav/`
- 用户名: `your-email@example.com`
- 密码: `应用密码（不是登录密码）`
- 使用 HTTPS: ✅ 是
- 超时时间: `30` 秒

**重要提示**:

- 坚果云需要使用**应用密码**，不是您的登录密码
- 获取应用密码：
  1. 登录坚果云网页版
  2. 进入"账户信息" → "安全选项"
  3. 点击"添加应用密码"
  4. 输入应用名称（如"LightSync"）
  5. 复制生成的应用密码

---

### Box

**服务器 URL 格式**:

```
https://dav.box.com/dav
```

**配置示例**:

- 服务器名称: `Box`
- 服务器 URL: `https://dav.box.com/dav`
- 用户名: `your-email@example.com`
- 密码: `your-password`
- 使用 HTTPS: ✅ 是
- 超时时间: `30` 秒

---

### 其他服务商

如果您使用的服务商不在上述列表中，请：

1. 查阅服务商的 WebDAV 配置文档
2. 确认 WebDAV 服务器 URL
3. 确认认证方式（用户名/密码）
4. 按照本指南的步骤进行配置

---

## 常见问题

### Q: 密码存储在哪里？安全吗？

**A**: 密码使用系统密钥环（Keyring）安全存储：

- **Windows**: Windows Credential Manager
- **macOS**: Keychain
- **Linux**: Secret Service API (如 GNOME Keyring)

密码经过操作系统级加密，不会以明文形式保存在配置文件或数据库中。

---

### Q: 可以添加多少个服务器？

**A**: LightSync 最多支持 10 个 WebDAV 服务器。

---

### Q: 如何知道服务器是否正常工作？

**A**: 有以下几种方式：

1. 查看服务器卡片上的状态图标
2. 查看"最后测试时间"
3. 点击"测试连接"按钮进行实时测试

---

### Q: 可以使用 HTTP 而不是 HTTPS 吗？

**A**: 可以，但不推荐：

- HTTP 传输数据未加密，存在安全风险
- 用户名和密码可能被窃取
- 文件内容可能被窃听
- 建议仅在内网环境或测试时使用 HTTP

---

### Q: 超时时间应该设置多少？

**A**: 建议根据网络情况设置：

- **快速网络**（光纤、5G）: 10-30 秒
- **普通网络**（4G、宽带）: 30-60 秒
- **慢速网络**（3G、卫星）: 60-120 秒
- **不稳定网络**: 120-300 秒

---

### Q: 编辑服务器时需要重新输入密码吗？

**A**: 不需要：

- 如果不修改密码，请保持密码字段为空
- 系统会保留原有密码
- 只有在需要更新密码时才输入新密码

---

### Q: 删除服务器会删除云端文件吗？

**A**: 不会：

- 删除服务器只会删除 LightSync 中的配置
- 云端文件不受影响
- 本地已同步的文件也不受影响

---

### Q: 可以同时连接多个服务器吗？

**A**: 可以：

- 您可以添加多个服务器（最多 10 个）
- 每个服务器可以独立配置和管理
- 可以为不同的同步文件夹选择不同的服务器

---

## 故障排除

### 连接失败：认证错误

**错误信息**: `Authentication failed` 或 `401 Unauthorized`

**可能原因**:

- 用户名或密码错误
- 使用了登录密码而不是应用密码（如坚果云）
- 账户被锁定或禁用

**解决方法**:

1. 检查用户名和密码是否正确
2. 确认是否需要使用应用密码
3. 尝试在浏览器中登录 WebDAV 服务
4. 联系服务商确认账户状态

---

### 连接失败：网络超时

**错误信息**: `Connection timeout` 或 `Network error`

**可能原因**:

- 网络连接不稳定
- 服务器地址错误
- 防火墙阻止连接
- 服务器宕机

**解决方法**:

1. 检查网络连接是否正常
2. 确认服务器 URL 是否正确
3. 尝试增加超时时间
4. 检查防火墙设置
5. 在浏览器中访问服务器 URL 确认可达性

---

### 连接失败：URL 格式错误

**错误信息**: `Invalid URL format`

**可能原因**:

- URL 缺少协议（`http://` 或 `https://`）
- URL 包含非法字符
- URL 格式不正确

**解决方法**:

1. 确保 URL 以 `http://` 或 `https://` 开头
2. 检查 URL 中是否有拼写错误
3. 参考[常见 WebDAV 服务商配置](#常见-webdav-服务商配置)中的示例
4. 咨询服务商获取正确的 WebDAV URL

---

### 连接失败：SSL 证书错误

**错误信息**: `SSL certificate error` 或 `Certificate verification failed`

**可能原因**:

- 服务器使用自签名证书
- 证书过期
- 证书域名不匹配

**解决方法**:

1. 如果是自签名证书，确认服务器可信后继续使用
2. 联系服务商更新证书
3. 检查系统时间是否正确
4. 如果是内网服务器，可以考虑使用 HTTP（不推荐）

---

### 连接失败：服务器不支持 WebDAV

**错误信息**: `WebDAV not supported` 或 `405 Method Not Allowed`

**可能原因**:

- 服务器未启用 WebDAV
- URL 指向了错误的路径
- 服务器配置错误

**解决方法**:

1. 确认服务器是否支持 WebDAV
2. 检查 WebDAV URL 是否正确
3. 咨询服务商或管理员
4. 参考服务商的 WebDAV 配置文档

---

### 无法删除服务器

**错误信息**: `Cannot delete server: it is being used by X sync folder(s)`

**原因**: 服务器正在被同步文件夹使用

**解决方法**:

1. 进入"同步文件夹"页面
2. 找到使用该服务器的同步文件夹
3. 删除或修改这些同步文件夹
4. 然后再删除服务器

---

### 密码保存失败

**错误信息**: `Failed to save password` 或 `Keyring not available`

**可能原因**:

- 系统密钥环服务未运行
- 权限不足
- 密钥环已锁定

**解决方法**:

**Windows**:

- 确保 Windows Credential Manager 服务正在运行

**macOS**:

- 确保 Keychain 未被锁定
- 在"钥匙串访问"中检查权限

**Linux**:

- 确保 GNOME Keyring 或其他密钥环服务正在运行
- 安装必要的密钥环软件包：

  ```bash
  # Ubuntu/Debian
  sudo apt install gnome-keyring

  # Fedora
  sudo dnf install gnome-keyring
  ```

---

### 测试连接很慢

**可能原因**:

- 网络延迟高
- 服务器响应慢
- 超时时间设置过长

**解决方法**:

1. 检查网络连接质量
2. 尝试减少超时时间
3. 选择地理位置更近的服务器
4. 联系服务商确认服务器状态

---

## 获取帮助

如果您遇到本指南未涵盖的问题，可以：

1. **查看日志文件**
   - 日志文件位置：`~/.lightsync/logs/`
   - 日志包含详细的错误信息

2. **访问项目主页**
   - GitHub: [LightSync Repository](https://github.com/your-repo/lightsync)
   - 提交 Issue 或查看已有的问题讨论

3. **联系技术支持**
   - 发送邮件至：support@lightsync.example.com
   - 请附上错误信息和日志文件

---

## 相关文档

- [快速开始指南](../md/快速开始.md)
- [同步文件夹配置](./sync-folder-configuration.md)
- [API 文档](../api/webdav-api.md)
- [开发指南](../md/开发指南.md)
