# LightSync 开发指南

## 代码规范

### TypeScript/React

1. **文件命名**
   - 组件文件：PascalCase (e.g., `UserProfile.tsx`)
   - 工具文件：camelCase (e.g., `fileUtils.ts`)
   - 样式文件：与组件同名 (e.g., `UserProfile.css`)

2. **组件编写**

   ```typescript
   import React from 'react'
   import { useTranslation } from 'react-i18next'

   interface Props {
     title: string
     onClose?: () => void
   }

   const MyComponent: React.FC<Props> = ({ title, onClose }) => {
     const { t } = useTranslation()

     return (
       <div>
         <h1>{title}</h1>
       </div>
     )
   }

   export default MyComponent
   ```

3. **Hook 使用**
   - 自定义 Hook 放在 `src/hooks/` 目录
   - Hook 文件名以 `use` 开头 (e.g., `useConfig.ts`)
   - 使用 TypeScript 类型注解

4. **导入顺序**

   ```typescript
   // 1. React 和第三方库
   import React from 'react'
   import { useTranslation } from 'react-i18next'

   // 2. 本地组件和工具
   import { Button } from '@nextui-org/react'
   import MyComponent from './MyComponent'

   // 3. 样式
   import './MyComponent.css'
   ```

### Rust

1. **文件命名**
   - 模块文件：snake_case (e.g., `file_watcher.rs`)
   - 结构体：PascalCase (e.g., `FileMetadata`)
   - 函数：snake_case (e.g., `get_file_metadata`)

2. **错误处理**

   ```rust
   use crate::error::{Result, SyncError};

   pub fn my_function() -> Result<String> {
       // 使用 ? 操作符自动传播错误
       let data = read_file("path")?;
       Ok(data)
   }
   ```

3. **Tauri 命令**

   ```rust
   #[tauri::command]
   pub fn my_command(param: String) -> Result<String> {
       // 命令实现
       Ok(format!("Hello, {}", param))
   }
   ```

4. **文档注释**
   ```rust
   /// 获取文件元数据
   ///
   /// # Arguments
   /// * `path` - 文件路径
   ///
   /// # Returns
   /// 返回文件元数据或错误
   pub fn get_metadata(path: &str) -> Result<FileMetadata> {
       // 实现
   }
   ```

## 添加新功能

### 添加新的 Tauri 命令

1. 在 `src-tauri/src/` 中创建新模块或编辑现有模块
2. 定义函数并使用 `#[tauri::command]` 宏
3. 在 `lib.rs` 中的 `invoke_handler` 中注册命令
4. 在前端创建对应的调用函数

**示例**：

后端 (`src-tauri/src/my_module.rs`):

```rust
#[tauri::command]
pub fn get_user_info(user_id: u32) -> Result<UserInfo> {
    // 实现
}
```

在 `lib.rs` 中注册:

```rust
.invoke_handler(tauri::generate_handler![
    my_module::get_user_info,
])
```

前端 (`src/utils/api.ts`):

```typescript
import { invoke } from '@tauri-apps/api/core'

export async function getUserInfo(userId: number) {
  return await invoke('get_user_info', { userId })
}
```

### 添加新的数据库表

1. 在 `src-tauri/migrations/` 中创建新的迁移文件
   - 命名格式：`NNN_description.sql`
   - 例如：`002_add_users_table.sql`

2. 编写 SQL 语句

3. 在 `lib.rs` 中注册迁移

**示例**：

`src-tauri/migrations/002_add_users_table.sql`:

```sql
CREATE TABLE IF NOT EXISTS users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT NOT NULL UNIQUE,
    email TEXT NOT NULL UNIQUE,
    created_at INTEGER NOT NULL DEFAULT (unixepoch())
);

CREATE INDEX IF NOT EXISTS idx_users_username ON users(username);
```

在 `lib.rs` 中:

```rust
.plugin(
    tauri_plugin_sql::Builder::new()
        .add_migrations(
            "sqlite:lightsync.db",
            vec![
                // ... 现有迁移
                tauri_plugin_sql::Migration {
                    version: 2,
                    description: "add users table",
                    sql: include_str!("../migrations/002_add_users_table.sql"),
                    kind: tauri_plugin_sql::MigrationKind::Up,
                },
            ],
        )
        .build(),
)
```

### 添加新的国际化字符串

1. 编辑 `src/i18n/locales/zh_CN.json` 添加中文翻译
2. 编辑 `src/i18n/locales/en_US.json` 添加英文翻译
3. 编辑其他语言文件

**示例**：

`src/i18n/locales/zh_CN.json`:

```json
{
  "myFeature": {
    "title": "我的功能",
    "description": "这是一个新功能"
  }
}
```

在组件中使用:

```typescript
const { t } = useTranslation()
const title = t('myFeature.title')
```

### 添加新的页面

1. 在 `src/pages/` 中创建新的页面组件
2. 在 `src/router/index.tsx` 中添加路由
3. 在 `src/components/NavigationMenu.tsx` 中添加导航菜单项

**示例**：

`src/pages/MyPage.tsx`:

```typescript
import React from 'react'
import { useTranslation } from 'react-i18next'

const MyPage: React.FC = () => {
  const { t } = useTranslation()

  return (
    <div>
      <h1>{t('myPage.title', '我的页面')}</h1>
    </div>
  )
}

export default MyPage
```

在 `src/router/index.tsx` 中:

```typescript
import MyPage from '../pages/MyPage'

const router = createBrowserRouter([
  {
    path: '/',
    element: <MainLayout />,
    children: [
      // ... 其他路由
      {
        path: 'my-page',
        element: <MyPage />,
      },
    ],
  },
])
```

## 测试

### 前端测试

```bash
# 运行测试（需要配置测试框架）
pnpm test

# 生成覆盖率报告
pnpm test:coverage
```

### 后端测试

```bash
cd src-tauri
cargo test
```

### 手动测试

1. 启动开发服务器：`pnpm tauri:dev`
2. 在应用中测试功能
3. 检查浏览器控制台和 Rust 日志

## 调试

### 前端调试

1. 按 F12 打开开发者工具
2. 使用 React DevTools 浏览器扩展
3. 在控制台查看日志

### 后端调试

1. 在 Rust 代码中添加 `println!` 或 `eprintln!` 宏
2. 在开发模式下，日志会输出到控制台
3. 使用 `dbg!` 宏快速调试

```rust
let value = 42;
dbg!(value);  // 输出: [src/main.rs:10] value = 42
```

### 数据库调试

1. 使用 SQLite 浏览器工具查看数据库
2. 数据库文件位置：`~/.lightsync/lightsync.db`
3. 或在应用中添加调试面板查看数据

## 性能优化

### 前端优化

1. **代码分割**

   ```typescript
   const MyComponent = React.lazy(() => import('./MyComponent'))
   ```

2. **记忆化**

   ```typescript
   const MemoComponent = React.memo(MyComponent)
   const memoCallback = useCallback(() => {}, [])
   ```

3. **虚拟化长列表**
   - 使用 NextUI Table 的虚拟化功能

### 后端优化

1. **异步操作**

   ```rust
   #[tokio::main]
   async fn main() {
       // 使用 tokio 处理异步操作
   }
   ```

2. **数据库索引**
   - 为常用查询字段添加索引

3. **缓存**
   - 使用配置缓存减少文件 I/O

## 常见问题

### Q: 如何调试 Tauri 命令？

A: 在 Rust 代码中添加 `println!` 或 `eprintln!`，在开发模式下会输出到控制台。

### Q: 如何处理异步操作？

A: 在前端使用 `async/await`，在后端使用 `tokio` 和 `async/await`。

### Q: 如何避免 N+1 查询？

A: 使用 SQL JOIN 或在应用层进行数据关联。

### Q: 如何处理大文件上传？

A: 使用分块上传，在数据库中记录上传进度。

## 提交代码

1. 确保代码通过类型检查：`pnpm tsc`
2. 格式化代码：`pnpm format`
3. 编写清晰的提交信息
4. 提交前测试功能

## 资源链接

- [Tauri 官方文档](https://tauri.app)
- [React 官方文档](https://react.dev)
- [Rust 官方文档](https://www.rust-lang.org/learn)
- [NextUI 文档](https://nextui.org)
- [TailwindCSS 文档](https://tailwindcss.com)
