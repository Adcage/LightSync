# LightSync é¡¹ç›®å­¦ä¹ æŒ‡å— - åŸºäº pot-desktop é¡¹ç›®åˆ†æ

## ğŸ“š ç›®å½•

1. [æŠ€æœ¯æ ˆä¸æ¶æ„](#1-æŠ€æœ¯æ ˆä¸æ¶æ„)
2. [é…ç½®ç®¡ç†ä¸æŒä¹…åŒ–](#2-é…ç½®ç®¡ç†ä¸æŒä¹…åŒ–)
3. [é”™è¯¯å¤„ç†ä¸ç±»å‹å®‰å…¨](#3-é”™è¯¯å¤„ç†ä¸ç±»å‹å®‰å…¨)
4. [å®‰å…¨æ€§ä¸éšç§ä¿æŠ¤](#4-å®‰å…¨æ€§ä¸éšç§ä¿æŠ¤)
5. [æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯](#5-æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯)
6. [çª—å£ç®¡ç†ä¸å¤šæ˜¾ç¤ºå™¨æ”¯æŒ](#6-çª—å£ç®¡ç†ä¸å¤šæ˜¾ç¤ºå™¨æ”¯æŒ)
7. [ç³»ç»Ÿé›†æˆ](#7-ç³»ç»Ÿé›†æˆ)
8. [å›½é™…åŒ–æ”¯æŒ](#8-å›½é™…åŒ–æ”¯æŒ)
9. [çŠ¶æ€ç®¡ç†](#9-çŠ¶æ€ç®¡ç†)
10. [UI/UX è®¾è®¡](#10-uiux-è®¾è®¡)
11. [æ›´æ–°æœºåˆ¶](#11-æ›´æ–°æœºåˆ¶)
12. [æ–‡ä»¶å¤‡ä»½ä¸åŒæ­¥](#12-æ–‡ä»¶å¤‡ä»½ä¸åŒæ­¥)
13. [æ„å»ºä¸æ‰“åŒ…](#13-æ„å»ºä¸æ‰“åŒ…)
14. [æ’ä»¶ç³»ç»Ÿè®¾è®¡](#14-æ’ä»¶ç³»ç»Ÿè®¾è®¡)
15. [HTTP æœåŠ¡å™¨ä¸äº‹ä»¶ç³»ç»Ÿ](#15-http-æœåŠ¡å™¨ä¸äº‹ä»¶ç³»ç»Ÿ)
16. [æ€§èƒ½ä¼˜åŒ–æŠ€å·§](#16-æ€§èƒ½ä¼˜åŒ–æŠ€å·§)
17. [å¹³å°ç‰¹å®šä»£ç å¤„ç†](#17-å¹³å°ç‰¹å®šä»£ç å¤„ç†)
18. [å›¾ç‰‡å¤„ç†ä¸ç¼“å­˜ç®¡ç†](#18-å›¾ç‰‡å¤„ç†ä¸ç¼“å­˜ç®¡ç†)
19. [ä»£ç†é…ç½®ç®¡ç†](#19-ä»£ç†é…ç½®ç®¡ç†)
20. [é”™è¯¯å¤„ç†ä¸æ—¥å¿—ç³»ç»Ÿ](#20-é”™è¯¯å¤„ç†ä¸æ—¥å¿—ç³»ç»Ÿ)
21. [æ€»ç»“ä¸å­¦ä¹ è·¯å¾„å»ºè®®](#æ€»ç»“ä¸å­¦ä¹ è·¯å¾„å»ºè®®)
22. [å‚è€ƒèµ„æº](#å‚è€ƒèµ„æº)
23. [æ£€æŸ¥æ¸…å•](#æ£€æŸ¥æ¸…å•)

---

## 1. æŠ€æœ¯æ ˆä¸æ¶æ„

### 1.1 æ ¸å¿ƒæŠ€æœ¯æ ˆå¯¹æ¯”

| æŠ€æœ¯æ ˆåˆ†ç±»     | pot-desktop              | é€‚ç”¨äº LightSync  |
| -------------- | ------------------------ | ----------------- |
| **å‰ç«¯æ¡†æ¶**   | React 18.3.1             | âœ… æ¨èä½¿ç”¨       |
| **UI ç»„ä»¶åº“**  | NextUI 2.x + TailwindCSS | âœ… ç°ä»£åŒ– UI æ–¹æ¡ˆ |
| **çŠ¶æ€ç®¡ç†**   | Jotai (åŸå­åŒ–çŠ¶æ€)       | âœ… è½»é‡çº§çŠ¶æ€ç®¡ç† |
| **è·¯ç”±**       | React Router v6          | âœ… é€‚åˆå¤šé¡µé¢é…ç½® |
| **åç«¯è¯­è¨€**   | Rust                     | âœ… é«˜æ€§èƒ½         |
| **Tauri ç‰ˆæœ¬** | 1.8                      | âœ… ç¨³å®šç‰ˆæœ¬       |
| **æ„å»ºå·¥å…·**   | Vite 5                   | âœ… å¿«é€Ÿå¼€å‘       |

**å­¦ä¹ è¦ç‚¹æ–‡ä»¶ä½ç½®ï¼š**

- å‰ç«¯é…ç½®ï¼š`package.json` (14-46è¡Œ)
- åç«¯é…ç½®ï¼š`src-tauri/Cargo.toml` (15-42è¡Œ)
- æ„å»ºé…ç½®ï¼š`vite.config.js`

### 1.2 é¡¹ç›®æ¶æ„è®¾è®¡

**æ¨¡å—åŒ–æ¶æ„ç¤ºä¾‹ï¼š**

```
src-tauri/src/
â”œâ”€â”€ main.rs          # åº”ç”¨å…¥å£
â”œâ”€â”€ config.rs        # é…ç½®ç®¡ç†
â”œâ”€â”€ error.rs         # é”™è¯¯å¤„ç†
â”œâ”€â”€ hotkey.rs        # å¿«æ·é”®ç®¡ç†
â”œâ”€â”€ window.rs        # çª—å£ç®¡ç†
â”œâ”€â”€ tray.rs          # ç³»ç»Ÿæ‰˜ç›˜
â”œâ”€â”€ clipboard.rs     # å‰ªè´´æ¿ç›‘æ§
â”œâ”€â”€ backup.rs        # å¤‡ä»½åŠŸèƒ½
â”œâ”€â”€ updater.rs       # æ›´æ–°æ£€æŸ¥
â”œâ”€â”€ screenshot.rs    # æˆªå›¾åŠŸèƒ½
â”œâ”€â”€ server.rs        # HTTP æœåŠ¡å™¨
â””â”€â”€ lang_detect.rs   # è¯­è¨€æ£€æµ‹
```

**å€¼å¾—å­¦ä¹ çš„æ¶æ„è®¾è®¡ï¼š**

1. **æ¨¡å—åŒ–åˆ†ç¦»**
   - æ–‡ä»¶ä½ç½®ï¼š`src-tauri/src/main.rs` (4-16è¡Œ)
   - æ¯ä¸ªåŠŸèƒ½ç‹¬ç«‹æ¨¡å—ï¼Œæ¸…æ™°çš„èŒè´£åˆ’åˆ†
   - ä¾¿äºç»´æŠ¤å’Œæµ‹è¯•

2. **å…¨å±€çŠ¶æ€ç®¡ç†**

   ```rust
   // src-tauri/src/main.rs (38-39è¡Œ)
   pub static APP: OnceCell<tauri::AppHandle> = OnceCell::new();
   ```

   - ä½¿ç”¨ `OnceCell` å®ç°å…¨å±€å•ä¾‹
   - é¿å…é‡å¤åˆå§‹åŒ–ï¼Œçº¿ç¨‹å®‰å…¨

3. **çŠ¶æ€åŒ…è£…å™¨æ¨¡å¼**

   ```rust
   // src-tauri/src/main.rs (42è¡Œ)
   pub struct StringWrapper(pub Mutex<String>);
   ```

   - ä½¿ç”¨ `Mutex` ä¿è¯çº¿ç¨‹å®‰å…¨
   - é€‚ç”¨äºè·¨çª—å£æ•°æ®å…±äº«

---

## 2. é…ç½®ç®¡ç†ä¸æŒä¹…åŒ–

### 2.1 é…ç½®å­˜å‚¨æ–¹æ¡ˆ

**Rust ç«¯é…ç½®ç®¡ç†ï¼š**

| åŠŸèƒ½           | å®ç°æ–¹å¼               | æ–‡ä»¶ä½ç½®                              | ä¼˜åŠ¿       |
| -------------- | ---------------------- | ------------------------------------- | ---------- |
| **é…ç½®åˆå§‹åŒ–** | `tauri-plugin-store`   | `src-tauri/src/config.rs` (11-27è¡Œ)   | è‡ªåŠ¨æŒä¹…åŒ– |
| **é…ç½®è¯»å–**   | `get(key)` å‡½æ•°        | `src-tauri/src/config.rs` (168-175è¡Œ) | ç±»å‹å®‰å…¨   |
| **é…ç½®å†™å…¥**   | `set(key, value)` å‡½æ•° | `src-tauri/src/config.rs` (177-182è¡Œ) | è‡ªåŠ¨ä¿å­˜   |
| **æ’ä»¶ç®¡ç†**   | åŠ¨æ€åŠ è½½æ’ä»¶åˆ—è¡¨       | `src-tauri/src/config.rs` (140-166è¡Œ) | æ‰©å±•æ€§å¼º   |

**æ ¸å¿ƒä»£ç ç¤ºä¾‹ï¼š**

```rust
// src-tauri/src/config.rs
pub fn init_config(app: &mut tauri::App) {
    let config_path = config_dir().unwrap();
    let config_path = config_path.join(app.config().tauri.bundle.identifier.clone());
    let config_path = config_path.join("config.json");
    info!("Load config from: {:?}", config_path);
    let mut store = StoreBuilder::new(app.handle(), config_path).build();

    match store.load() {
        Ok(_) => info!("Config loaded"),
        Err(e) => {
            warn!("Config load error: {:?}", e);
            info!("Config not found, creating new config");
        }
    }
    app.manage(StoreWrapper(Mutex::new(store)));
}
```

**å€¼å¾—å­¦ä¹ çš„è®¾è®¡ï¼š**

1. âœ… ä½¿ç”¨æ“ä½œç³»ç»Ÿæ ‡å‡†é…ç½®ç›®å½•
2. âœ… è‡ªåŠ¨åˆ›å»ºé…ç½®æ–‡ä»¶
3. âœ… é”™è¯¯å¤„ç†å‹å¥½ï¼Œä¸ä¼šå› é…ç½®é—®é¢˜å´©æºƒ
4. âœ… ä½¿ç”¨ `Mutex` ä¿è¯å¹¶å‘å®‰å…¨

### 2.2 å‰ç«¯é…ç½®åŒæ­¥

**React è‡ªå®šä¹‰ Hookï¼š**

æ–‡ä»¶ï¼š`src/hooks/useConfig.jsx`

```javascript
export const useConfig = (key, defaultValue, options = {}) => {
  const [property, setPropertyState, getProperty] = useGetState(null)
  const { sync = true } = options

  // åŒæ­¥åˆ°Store (State -> Store)
  const syncToStore = useCallback(
    debounce(v => {
      store.set(key, v)
      store.save()
      let eventKey = key.replaceAll('.', '_').replaceAll('@', ':')
      emit(`${eventKey}_changed`, v)
    }),
    []
  )

  // åŒæ­¥åˆ°State (Store -> State)
  const syncToState = useCallback(v => {
    if (v !== null) {
      setPropertyState(v)
    } else {
      store.get(key).then(v => {
        if (v === null) {
          setPropertyState(defaultValue)
          store.set(key, defaultValue)
          store.save()
        } else {
          setPropertyState(v)
        }
      })
    }
  }, [])

  return [property, setProperty, getProperty]
}
```

**å­¦ä¹ è¦ç‚¹ï¼š**

| ç‰¹æ€§           | è¯´æ˜                    | ä»£ç ä½ç½®                         |
| -------------- | ----------------------- | -------------------------------- |
| **åŒå‘åŒæ­¥**   | State â†” Store è‡ªåŠ¨åŒæ­¥ | `useConfig.jsx` (12-20, 23-37è¡Œ) |
| **äº‹ä»¶é©±åŠ¨**   | é…ç½®å˜æ›´æ—¶å‘é€äº‹ä»¶é€šçŸ¥  | `useConfig.jsx` (17è¡Œ)           |
| **é˜²æŠ–ä¼˜åŒ–**   | é¿å…é¢‘ç¹å†™å…¥ç£ç›˜        | `useConfig.jsx` (13è¡Œ)           |
| **é»˜è®¤å€¼å¤„ç†** | è‡ªåŠ¨è®¾ç½®å’Œä¿å­˜é»˜è®¤å€¼    | `useConfig.jsx` (28-33è¡Œ)        |

### 2.3 é…ç½®æ–‡ä»¶ç›‘å¬

**å®æ—¶ç›‘å¬é…ç½®å˜æ›´ï¼š**

æ–‡ä»¶ï¼š`src/utils/store.js`

```javascript
export async function initStore() {
  const appConfigDirPath = await appConfigDir()
  const appConfigPath = await join(appConfigDirPath, 'config.json')
  store = new Store(appConfigPath)
  const _ = await watch(appConfigPath, async () => {
    await store.load()
    await invoke('reload_store')
  })
}
```

**é€‚ç”¨äº LightSync çš„åœºæ™¯ï¼š**

- âœ… ç›‘å¬åŒæ­¥é…ç½®å˜æ›´
- âœ… WebDAV æœåŠ¡å™¨é…ç½®æ›´æ–°
- âœ… å¤šçª—å£é…ç½®åŒæ­¥

---

## 3. é”™è¯¯å¤„ç†ä¸ç±»å‹å®‰å…¨

### 3.1 ç»Ÿä¸€é”™è¯¯ç±»å‹

**ä½¿ç”¨ `thiserror` crate ä¼˜é›…å¤„ç†é”™è¯¯ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/error.rs`

```rust
#[derive(Debug, thiserror::Error)]
pub enum Error {
    #[error(transparent)]
    Io(#[from] std::io::Error),
    #[error(transparent)]
    Dav(#[from] reqwest_dav::Error),
    #[error(transparent)]
    DavRe(#[from] reqwest_dav::re_exports::reqwest::Error),
    #[error(transparent)]
    Serde(#[from] serde_json::Error),
    #[error(transparent)]
    Zip(#[from] zip::result::ZipError),
    #[error(transparent)]
    WalkDir(#[from] walkdir::Error),
    #[error(transparent)]
    Tauri(#[from] tauri::Error),
    // ... æ›´å¤šé”™è¯¯ç±»å‹
}

// å®ç° Serialize ä½¿é”™è¯¯å¯ä»¥ä¼ é€’åˆ°å‰ç«¯
impl serde::Serialize for Error {
    fn serialize<S>(&self, serializer: S) -> Result<S::Ok, S::Error>
    where
        S: serde::ser::Serializer,
    {
        serializer.serialize_str(self.to_string().as_ref())
    }
}
```

**å­¦ä¹ è¦ç‚¹è¡¨æ ¼ï¼š**

| ç‰¹æ€§             | ä¼˜åŠ¿                                     | é€‚ç”¨åœºæ™¯                  |
| ---------------- | ---------------------------------------- | ------------------------- |
| **è‡ªåŠ¨ç±»å‹è½¬æ¢** | `#[from]` è‡ªåŠ¨è½¬æ¢é”™è¯¯ç±»å‹               | WebDAV é”™è¯¯ã€æ–‡ä»¶ IO é”™è¯¯ |
| **ç»Ÿä¸€é”™è¯¯å¤„ç†** | ä¸€ä¸ª Error æšä¸¾å¤„ç†æ‰€æœ‰é”™è¯¯              | ç®€åŒ–é”™è¯¯ä¼ æ’­              |
| **å‰ç«¯å…¼å®¹**     | å®ç° Serialize ä¼ é€’åˆ° JS                 | ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º        |
| **é€æ˜é”™è¯¯**     | `#[error(transparent)]` ä¿ç•™åŸå§‹é”™è¯¯ä¿¡æ¯ | è°ƒè¯•å’Œæ—¥å¿—è®°å½•            |

**å¯¹ LightSync çš„å¯ç¤ºï¼š**

```rust
// å»ºè®®çš„ LightSync é”™è¯¯ç±»å‹
#[derive(Debug, thiserror::Error)]
pub enum SyncError {
    #[error(transparent)]
    Io(#[from] std::io::Error),
    #[error(transparent)]
    WebDav(#[from] reqwest_dav::Error),
    #[error("Sync conflict: {0}")]
    Conflict(String),
    #[error("Network error: {0}")]
    Network(String),
    #[error("Authentication failed")]
    AuthError,
}
```

---

## 4. å®‰å…¨æ€§ä¸éšç§ä¿æŠ¤

### 4.1 Tauri å®‰å…¨é…ç½®

**allowlist æœ€å°æƒé™åŸåˆ™ï¼š**

æ–‡ä»¶ï¼š`src-tauri/tauri.conf.json` (14-63è¡Œ)

```json
{
  "allowlist": {
    "all": false, // âš ï¸ å…³é”®ï¼šé»˜è®¤æ‹’ç»æ‰€æœ‰æƒé™
    "shell": {
      "all": true,
      "open": ".*" // å…è®¸æ‰“å¼€å¤–éƒ¨é“¾æ¥
    },
    "fs": {
      "all": true,
      "scope": [
        "$APPCONFIG/**", // ä»…é™åº”ç”¨é…ç½®ç›®å½•
        "$APPCACHE/**" // ä»…é™åº”ç”¨ç¼“å­˜ç›®å½•
      ]
    },
    "http": {
      "all": true,
      "request": true,
      "scope": ["http://**", "https://**"]
    }
  }
}
```

**å®‰å…¨é…ç½®å¯¹æ¯”è¡¨ï¼š**

| æƒé™ç±»å‹     | pot-desktop é…ç½®                | LightSync å»ºè®®               | ç†ç”±             |
| ------------ | ------------------------------- | ---------------------------- | ---------------- |
| **æ–‡ä»¶ç³»ç»Ÿ** | `$APPCONFIG/**`, `$APPCACHE/**` | âœ… åŒæ ·ç­–ç•¥ + åŒæ­¥ç›®å½•ç™½åå• | é˜²æ­¢è®¿é—®æ•æ„Ÿæ–‡ä»¶ |
| **ç½‘ç»œè¯·æ±‚** | `http://**`, `https://**`       | âœ… é™åˆ¶ä¸º WebDAV æœåŠ¡å™¨åŸŸå  | å‡å°‘æ”»å‡»é¢       |
| **Shell**    | `open: ".*"`                    | âš ï¸ é™åˆ¶ä¸ºå¿…è¦çš„å‘½ä»¤          | é˜²æ­¢å‘½ä»¤æ³¨å…¥     |
| **å‰ªè´´æ¿**   | `all: true`                     | âŒ LightSync ä¸éœ€è¦          | æœ€å°æƒé™åŸåˆ™     |

### 4.2 CSP (Content Security Policy)

**å†…å®¹å®‰å…¨ç­–ç•¥é…ç½®ï¼š**

æ–‡ä»¶ï¼š`src-tauri/tauri.conf.json` (106-109è¡Œ)

```json
{
  "security": {
    "csp": "default-src * data: ; img-src * 'self' asset: https: data: ; style-src * 'unsafe-inline'; worker-src 'self' blob: ; script-src * 'unsafe-eval';",
    "devCsp": "default-src * data: ; img-src * 'self' asset: https: data: ; style-src * 'unsafe-inline'; worker-src 'self' blob: ; script-src * 'unsafe-eval';"
  }
}
```

**å¯¹ LightSync çš„å»ºè®®ï¼š**

```json
{
  "security": {
    "csp": "default-src 'self'; connect-src 'self' https://your-webdav-server.com; img-src 'self' data: https:; style-src 'self' 'unsafe-inline'; script-src 'self'"
  }
}
```

### 4.3 æ•æ„Ÿæ•°æ®å¤„ç†

**å¯†ç å­˜å‚¨æ–¹æ¡ˆï¼š**

è™½ç„¶ pot-desktop ä½¿ç”¨äº† WebDAV å¤‡ä»½ï¼ˆ`src-tauri/src/backup.rs`ï¼‰ï¼Œä½†æ²¡æœ‰å±•ç¤ºå¯†ç åŠ å¯†ï¼Œè¿™é‡Œæ˜¯**æ¨èçš„å®‰å…¨å®è·µ**ï¼š

```rust
// å»ºè®®ï¼šä½¿ç”¨ keyring crate å­˜å‚¨å¯†ç 
use keyring::Entry;

pub fn save_password(service: &str, username: &str, password: &str) -> Result<()> {
    let entry = Entry::new(service, username)?;
    entry.set_password(password)?;
    Ok(())
}

pub fn get_password(service: &str, username: &str) -> Result<String> {
    let entry = Entry::new(service, username)?;
    entry.get_password()
}
```

**å®‰å…¨æœ€ä½³å®è·µè¡¨ï¼š**

| å®‰å…¨æªæ–½         | pot-desktop         | LightSync å»ºè®®               | ä¼˜å…ˆçº§ |
| ---------------- | ------------------- | ---------------------------- | ------ |
| **å¯†ç åŠ å¯†å­˜å‚¨** | âŒ æœªä½¿ç”¨ç³»ç»Ÿå¯†é’¥é“¾ | âœ… ä½¿ç”¨ `keyring` crate      | ğŸ”´ P0  |
| **HTTPS éªŒè¯**   | âœ… ä½¿ç”¨ reqwest     | âœ… ä¿æŒ                      | ğŸ”´ P0  |
| **é…ç½®æ–‡ä»¶æƒé™** | âš ï¸ æœªæ˜ç¡®è®¾ç½®       | âœ… è®¾ç½®ä¸º 600 (ä»…ç”¨æˆ·å¯è¯»å†™) | ğŸŸ¡ P1  |
| **æ—¥å¿—è„±æ•**     | âš ï¸ å¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯ | âœ… ç§»é™¤å¯†ç ã€URL ç­‰æ•æ„Ÿæ•°æ®  | ğŸŸ¡ P1  |

---

## 5. æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯

### 5.1 å¹¶å‘ä¸å¼‚æ­¥å¤„ç†

**Tauri å¼‚æ­¥å‘½ä»¤ç¤ºä¾‹ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/backup.rs` (10è¡Œ)

```rust
#[tauri::command(async)]
pub async fn webdav(
    operate: &str,
    url: String,
    username: String,
    password: String,
    name: Option<String>,
) -> Result<String, Error> {
    // å¼‚æ­¥ WebDAV æ“ä½œ
    let client = ClientBuilder::new()
        .set_host(url.clone())
        .set_auth(Auth::Basic(username.clone(), password.clone()))
        .build()?;
    // ...
}
```

**æ€§èƒ½ä¼˜åŒ–è¦ç‚¹ï¼š**

| æŠ€æœ¯           | å®ç°ä½ç½®               | æ•ˆæœ              | é€‚ç”¨åœºæ™¯             |
| -------------- | ---------------------- | ----------------- | -------------------- |
| **å¼‚æ­¥ I/O**   | `backup.rs` (10è¡Œ)     | é¿å…é˜»å¡ä¸»çº¿ç¨‹    | ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶æ“ä½œ   |
| **å¹¶å‘ä»»åŠ¡**   | `clipboard.rs` (7è¡Œ)   | åå°ç›‘æ§ä¸å½±å“ UI | å‰ªè´´æ¿ç›‘æ§ã€æ–‡ä»¶ç›‘æ§ |
| **é˜²æŠ–ä¼˜åŒ–**   | `useConfig.jsx` (13è¡Œ) | å‡å°‘ç£ç›˜å†™å…¥      | é…ç½®ä¿å­˜             |
| **å»¶è¿Ÿåˆå§‹åŒ–** | `lang_detect.rs` (1è¡Œ) | åŠ å¿«å¯åŠ¨é€Ÿåº¦      | è¯­è¨€æ£€æµ‹æ¨¡å‹         |

### 5.2 å†…å­˜ç®¡ç†

**é«˜æ•ˆçš„å‰ªè´´æ¿ç›‘æ§ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/clipboard.rs`

```rust
pub fn start_clipboard_monitor(app_handle: tauri::AppHandle) {
    tauri::async_runtime::spawn(async move {
        let mut pre_text = "".to_string();
        loop {
            let handle = app_handle.app_handle();
            let state = handle.state::<ClipboardMonitorEnableWrapper>();
            if let Ok(clipboard_monitor) = state.0.try_lock() {
                if clipboard_monitor.contains("true") {
                    if let Ok(result) = app_handle.clipboard_manager().read_text() {
                        match result {
                            Some(v) => {
                                if v != pre_text {  // âœ… é¿å…é‡å¤å¤„ç†
                                    text_translate(v.clone());
                                    pre_text = v;
                                }
                            }
                            None => {}
                        }
                    }
                } else {
                    break;  // âœ… åŠæ—¶é€€å‡ºå¾ªç¯é‡Šæ”¾èµ„æº
                }
            }
            std::thread::sleep(std::time::Duration::from_millis(500));
        }
    });
}
```

**å­¦ä¹ è¦ç‚¹ï¼š**

1. âœ… ä½¿ç”¨ `pre_text` é¿å…é‡å¤å¤„ç†ç›¸åŒå†…å®¹
2. âœ… æ¡ä»¶é€€å‡ºå¾ªç¯ï¼Œé¿å…èµ„æºæ³„æ¼
3. âœ… `try_lock` é¿å…æ­»é”
4. âœ… 500ms è½®è¯¢é—´éš”å¹³è¡¡å®æ—¶æ€§å’Œæ€§èƒ½

### 5.3 Vite æ„å»ºä¼˜åŒ–

**å¤šå…¥å£æ„å»ºé…ç½®ï¼š**

æ–‡ä»¶ï¼š`vite.config.js` (20-26è¡Œ)

```javascript
build: {
    rollupOptions: {
        input: {
            index: resolve(__dirname, 'index.html'),
            daemon: resolve(__dirname, 'daemon.html'),  // åå°å®ˆæŠ¤çª—å£
        },
    },
    target: process.env.TAURI_PLATFORM == 'windows' ? 'chrome105' : 'safari11',
    minify: !process.env.TAURI_DEBUG ? 'esbuild' : false,
    sourcemap: !!process.env.TAURI_DEBUG,
}
```

**æ„å»ºä¼˜åŒ–è¡¨ï¼š**

| ä¼˜åŒ–é¡¹         | é…ç½®                   | æ•ˆæœ               |
| -------------- | ---------------------- | ------------------ |
| **å¤šå…¥å£**     | `daemon.html` ç‹¬ç«‹æ‰“åŒ… | å‡å°‘ä¸»çª—å£åŠ è½½æ—¶é—´ |
| **æ¡ä»¶å‹ç¼©**   | Debug æ¨¡å¼ä¸å‹ç¼©       | åŠ å¿«å¼€å‘æ„å»ºé€Ÿåº¦   |
| **ç›®æ ‡æµè§ˆå™¨** | Chrome 105 / Safari 11 | æ›´å¥½çš„æ€§èƒ½å’Œå…¼å®¹æ€§ |
| **SourceMap**  | ä»… Debug æ¨¡å¼          | å‡å°ç”Ÿäº§åŒ…ä½“ç§¯     |

---

## 6. çª—å£ç®¡ç†ä¸å¤šæ˜¾ç¤ºå™¨æ”¯æŒ

### 6.1 å¤šæ˜¾ç¤ºå™¨æ£€æµ‹

**æ™ºèƒ½çª—å£å®šä½ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/window.rs` (38-58è¡Œ)

```rust
fn get_current_monitor(x: i32, y: i32) -> Monitor {
    info!("Mouse position: {}, {}", x, y);
    let daemon_window = get_daemon_window();
    let monitors = daemon_window.available_monitors().unwrap();

    for m in monitors {
        let size = m.size();
        let position = m.position();

        if x >= position.x
            && x <= (position.x + size.width as i32)
            && y >= position.y
            && y <= (position.y + size.height as i32)
        {
            info!("Current Monitor: {:?}", m);
            return m;
        }
    }
    warn!("Current Monitor not found, using primary monitor");
    daemon_window.primary_monitor().unwrap().unwrap()
}
```

**å€¼å¾—å­¦ä¹ çš„å¤šæ˜¾ç¤ºå™¨å¤„ç†ï¼š**

| åŠŸèƒ½                   | å®ç°æ–¹æ³•                   | ä»£ç ä½ç½®                | LightSync åº”ç”¨                |
| ---------------------- | -------------------------- | ----------------------- | ----------------------------- |
| **æ£€æµ‹é¼ æ ‡æ‰€åœ¨æ˜¾ç¤ºå™¨** | éå†æ‰€æœ‰æ˜¾ç¤ºå™¨ï¼Œæ¯”è¾ƒåæ ‡   | `window.rs` (43-54è¡Œ)   | âœ… åŒæ­¥çŠ¶æ€çª—å£æ˜¾ç¤ºåœ¨å½“å‰å±å¹• |
| **DPI ç¼©æ”¾æ”¯æŒ**       | `monitor.scale_factor()`   | `window.rs` (157è¡Œ)     | âœ… é«˜ DPI å±å¹•é€‚é…            |
| **è¾¹ç•Œæ£€æµ‹**           | é˜²æ­¢çª—å£è¶…å‡ºå±å¹•           | `window.rs` (181-196è¡Œ) | âœ… é˜²æ­¢çª—å£ä¸å¯è§             |
| **å›é€€æœºåˆ¶**           | æ‰¾ä¸åˆ°æ˜¾ç¤ºå™¨æ—¶ä½¿ç”¨ä¸»æ˜¾ç¤ºå™¨ | `window.rs` (56-57è¡Œ)   | âœ… æé«˜å¯é æ€§                 |

### 6.2 çª—å£çŠ¶æ€ç®¡ç†

**çª—å£åˆ›å»ºä¸å¤ç”¨ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/window.rs` (61-114è¡Œ)

```rust
fn build_window(label: &str, title: &str) -> (Window, bool) {
    let app_handle = APP.get().unwrap();
    match app_handle.get_window(label) {
        Some(v) => {
            info!("Window existence: {}", label);
            v.set_focus().unwrap();
            (v, true)  // âœ… å¤ç”¨å·²å­˜åœ¨çš„çª—å£
        }
        None => {
            info!("Window not existence, Creating new window: {}", label);
            let mut builder = tauri::WindowBuilder::new(
                app_handle,
                label,
                tauri::WindowUrl::App("index.html".into()),
            )
            .position(position.x.into(), position.y.into())
            .additional_browser_args("--disable-web-security")
            .focused(true)
            .title(title)
            .visible(false);  // âœ… å…ˆéšè—ï¼Œå‡†å¤‡å¥½åå†æ˜¾ç¤º

            #[cfg(target_os = "macos")]
            {
                builder = builder
                    .title_bar_style(tauri::TitleBarStyle::Overlay)
                    .hidden_title(true);
            }
            #[cfg(not(target_os = "macos"))]
            {
                builder = builder.transparent(true).decorations(false);
            }
            let window = builder.build().unwrap();
            // âœ… macOS/Windows æ·»åŠ é˜´å½±æ•ˆæœ
            #[cfg(not(target_os = "linux"))]
            set_shadow(&window, true).unwrap_or_default();

            (window, false)
        }
    }
}
```

**çª—å£ç®¡ç†æœ€ä½³å®è·µï¼š**

| å®è·µ           | è¯´æ˜                      | ä»£ç ä½ç½®                | å­¦ä¹ ä»·å€¼   |
| -------------- | ------------------------- | ----------------------- | ---------- |
| **çª—å£å¤ç”¨**   | é¿å…é‡å¤åˆ›å»ºï¼Œæå‡æ€§èƒ½    | `window.rs` (76-79è¡Œ)   | â­â­â­â­â­ |
| **å¹³å°å·®å¼‚åŒ–** | macOS ä½¿ç”¨ Overlay æ ‡é¢˜æ  | `window.rs` (94-103è¡Œ)  | â­â­â­â­â­ |
| **å»¶è¿Ÿæ˜¾ç¤º**   | `visible(false)` é¿å…é—ªçƒ | `window.rs` (92è¡Œ)      | â­â­â­â­   |
| **é˜´å½±æ•ˆæœ**   | æå‡è§†è§‰ä½“éªŒ              | `window.rs` (107-108è¡Œ) | â­â­â­     |

### 6.3 çª—å£ä½ç½®è®¡ç®—

**æ™ºèƒ½çª—å£å®šä½ç®—æ³•ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/window.rs` (125-224è¡Œ)

```rust
fn translate_window() -> Window {
    // è·å–é¼ æ ‡ç‰©ç†ä½ç½®
    let mut mouse_position = match Mouse::get_mouse_position() {
        Mouse::Position { x, y } => Position { x, y },
        Mouse::Error => {
            warn!("Mouse position not found, using (0, 0) as default");
            Position { x: 0, y: 0 }
        }
    };

    let monitor = window.current_monitor().unwrap().unwrap();
    let dpi = monitor.scale_factor();

    // DPI ç¼©æ”¾è®¡ç®—
    window.set_size(tauri::PhysicalSize::new(
        (width as f64) * dpi,
        (height as f64) * dpi,
    )).unwrap();

    // è¾¹ç•Œæ£€æµ‹ï¼šé˜²æ­¢çª—å£è¶…å‡ºå³è¾¹ç•Œ
    if mouse_position.x as f64 + width as f64 * dpi
        > monitor_position_x + monitor_size_width
    {
        mouse_position.x -= (width as f64 * dpi) as i32;
        if (mouse_position.x as f64) < monitor_position_x {
            mouse_position.x = monitor_position_x as i32;
        }
    }

    // è¾¹ç•Œæ£€æµ‹ï¼šé˜²æ­¢çª—å£è¶…å‡ºåº•éƒ¨
    if mouse_position.y as f64 + height as f64 * dpi
        > monitor_position_y + monitor_size_height
    {
        mouse_position.y -= (height as f64 * dpi) as i32;
        if (mouse_position.y as f64) < monitor_position_y {
            mouse_position.y = monitor_position_y as i32;
        }
    }

    window.set_position(tauri::PhysicalPosition::new(
        mouse_position.x,
        mouse_position.y,
    )).unwrap();

    window
}
```

**LightSync åŒæ­¥çª—å£å®šä½å»ºè®®ï¼š**

```rust
// å»ºè®®ï¼šæ˜¾ç¤ºåŒæ­¥è¿›åº¦çª—å£åœ¨å±å¹•ä¸­å¤®
pub fn show_sync_progress_window() {
    let (window, exists) = build_window("sync_progress", "Syncing...");
    if !exists {
        window.center().unwrap();  // å±…ä¸­æ˜¾ç¤º
        window.set_size(tauri::LogicalSize::new(400, 200)).unwrap();
        window.set_skip_taskbar(true).unwrap();  // ä¸æ˜¾ç¤ºåœ¨ä»»åŠ¡æ 
    }
    window.show().unwrap();
}
```

---

## 7. ç³»ç»Ÿé›†æˆ

### 7.1 ç³»ç»Ÿæ‰˜ç›˜

**å¤šè¯­è¨€æ‰˜ç›˜èœå•ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/tray.rs`

```rust
#[tauri::command]
pub fn update_tray(app_handle: tauri::AppHandle, mut language: String, mut copy_mode: String) {
    let tray_handle = app_handle.tray_handle();

    // æ ¹æ®è¯­è¨€è®¾ç½®æ‰˜ç›˜èœå•
    tray_handle.set_menu(match language.as_str() {
        "en" => tray_menu_en(),
        "zh_cn" => tray_menu_zh_cn(),
        "zh_tw" => tray_menu_zh_tw(),
        "ja" => tray_menu_ja(),
        // ... æ›´å¤šè¯­è¨€
        _ => tray_menu_en(),
    }).unwrap();

    // è®¾ç½®æ‰˜ç›˜æç¤º
    #[cfg(not(target_os = "linux"))]
    tray_handle.set_tooltip(&format!("pot {}", app_handle.package_info().version)).unwrap();

    // æ›´æ–°èœå•é¡¹é€‰ä¸­çŠ¶æ€
    tray_handle.get_item("clipboard_monitor")
        .set_selected(enable_clipboard_monitor)
        .unwrap();
}
```

**æ‰˜ç›˜èœå•è®¾è®¡æ¨¡å¼ï¼š**

| èœå•é¡¹       | pot-desktop                     | LightSync å»ºè®®           | è¯´æ˜     |
| ------------ | ------------------------------- | ------------------------ | -------- |
| **å¿«é€Ÿæ“ä½œ** | è¾“å…¥ç¿»è¯‘ã€OCR è¯†åˆ«              | âœ… ç«‹å³åŒæ­¥ã€æš‚åœåŒæ­¥    | é«˜é¢‘æ“ä½œ |
| **åŠŸèƒ½å¼€å…³** | å‰ªè´´æ¿ç›‘æ§ (checkable)          | âœ… è‡ªåŠ¨åŒæ­¥ (checkable)  | çŠ¶æ€åˆ‡æ¢ |
| **å­èœå•**   | è‡ªåŠ¨å¤åˆ¶ï¼ˆå•é€‰ï¼‰                | âœ… åŒæ­¥æ¨¡å¼ï¼ˆåŒå‘/å•å‘ï¼‰ | åˆ†ç»„é€‰é¡¹ |
| **åˆ†éš”çº¿**   | `SystemTrayMenuItem::Separator` | âœ… é€»è¾‘åˆ†ç»„              | è§†è§‰å±‚æ¬¡ |
| **ç³»ç»Ÿæ“ä½œ** | è®¾ç½®ã€é‡å¯ã€é€€å‡º                | âœ… åŒæ ·ç»“æ„              | æ ‡å‡†é¡¹   |

**æ‰˜ç›˜äº‹ä»¶å¤„ç†ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/tray.rs` (99-121è¡Œ)

```rust
pub fn tray_event_handler<'a>(app: &'a AppHandle, event: SystemTrayEvent) {
    match event {
        #[cfg(target_os = "windows")]
        SystemTrayEvent::LeftClick { .. } => on_tray_click(),  // Windows å·¦é”®ç‚¹å‡»

        SystemTrayEvent::MenuItemClick { id, .. } => match id.as_str() {
            "input_translate" => on_input_translate_click(),
            "clipboard_monitor" => on_clipboard_monitor_click(app),
            "config" => on_config_click(),
            "quit" => on_quit_click(app),
            _ => {}
        },
        _ => {}
    }
}
```

**å¹³å°å·®å¼‚åŒ–å¤„ç†ï¼š**

- Windows: å·¦é”®ç‚¹å‡»æ‰˜ç›˜å›¾æ ‡æ‰§è¡Œé»˜è®¤æ“ä½œ
- macOS/Linux: ä»…å³é”®èœå•

### 7.2 å…¨å±€å¿«æ·é”®

**å¿«æ·é”®æ³¨å†Œä¸ç®¡ç†ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/hotkey.rs`

```rust
fn register<F>(app_handle: &AppHandle, name: &str, handler: F, key: &str) -> Result<(), String>
where
    F: Fn() + Send + 'static,
{
    let hotkey = {
        if key.is_empty() {
            match get(name) {
                Some(v) => v.as_str().unwrap().to_string(),
                None => {
                    set(name, "");
                    String::new()
                }
            }
        } else {
            key.to_string()
        }
    };

    if !hotkey.is_empty() {
        match app_handle.global_shortcut_manager().register(hotkey.as_str(), handler) {
            Ok(()) => {
                info!("Registered global shortcut: {} for {}", hotkey, name);
            }
            Err(e) => {
                warn!("Failed to register global shortcut: {} {:?}", hotkey, e);
                return Err(e.to_string());
            }
        };
    }
    Ok(())
}

// æ³¨å†Œæ‰€æœ‰å¿«æ·é”®
pub fn register_shortcut(shortcut: &str) -> Result<(), String> {
    let app_handle = APP.get().unwrap();
    match shortcut {
        "hotkey_selection_translate" => register(
            app_handle,
            "hotkey_selection_translate",
            selection_translate,
            "",
        )?,
        "all" => {
            register(app_handle, "hotkey_selection_translate", selection_translate, "")?;
            register(app_handle, "hotkey_input_translate", input_translate, "")?;
            register(app_handle, "hotkey_ocr_recognize", ocr_recognize, "")?;
            register(app_handle, "hotkey_ocr_translate", ocr_translate, "")?;
        }
        _ => {}
    }
    Ok(())
}
```

**å¿«æ·é”®è®¾è®¡è¦ç‚¹ï¼š**

| ç‰¹æ€§         | å®ç°æ–¹å¼                 | ä»£ç ä½ç½®              | å­¦ä¹ ä»·å€¼   |
| ------------ | ------------------------ | --------------------- | ---------- |
| **åŠ¨æ€æ³¨å†Œ** | ä»é…ç½®è¯»å–å¿«æ·é”®         | `hotkey.rs` (11-16è¡Œ) | â­â­â­â­â­ |
| **é”™è¯¯å¤„ç†** | æ³¨å†Œå¤±è´¥ä¸å´©æºƒ           | `hotkey.rs` (26-35è¡Œ) | â­â­â­â­   |
| **æ‰¹é‡æ³¨å†Œ** | "all" æ¨¡å¼æ³¨å†Œæ‰€æœ‰å¿«æ·é”® | `hotkey.rs` (57-66è¡Œ) | â­â­â­â­   |
| **å‰ç«¯æ³¨å†Œ** | å…è®¸å‰ç«¯åŠ¨æ€ä¿®æ”¹å¿«æ·é”®   | `hotkey.rs` (74-98è¡Œ) | â­â­â­â­â­ |

**LightSync å¿«æ·é”®å»ºè®®ï¼š**

```rust
pub fn register_sync_shortcuts() -> Result<(), String> {
    let app_handle = APP.get().unwrap();
    register(app_handle, "hotkey_quick_sync", trigger_quick_sync, "")?;
    register(app_handle, "hotkey_pause_sync", toggle_sync_pause, "")?;
    register(app_handle, "hotkey_show_sync_status", show_sync_status, "")?;
    Ok(())
}
```

### 7.3 è‡ªåŠ¨å¯åŠ¨

**ä½¿ç”¨ tauri-plugin-autostartï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/main.rs` (59-62è¡Œ)

```rust
.plugin(tauri_plugin_autostart::init(
    tauri_plugin_autostart::MacosLauncher::LaunchAgent,
    Some(vec![]),  // å¯åŠ¨å‚æ•°
))
```

**é…ç½®æ–‡ä»¶ï¼š**

```toml
# Cargo.toml
tauri-plugin-autostart = { git = "https://github.com/tauri-apps/plugins-workspace", branch = "v1" }
```

**å¹³å°æ”¯æŒï¼š**

- âœ… Windows: æ³¨å†Œè¡¨å¯åŠ¨é¡¹
- âœ… macOS: LaunchAgent
- âœ… Linux: .desktop æ–‡ä»¶

### 7.4 å•å®ä¾‹æ£€æµ‹

**é˜²æ­¢é‡å¤å¯åŠ¨ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/main.rs` (46-53è¡Œ)

```rust
.plugin(tauri_plugin_single_instance::init(|app, _, cwd| {
    Notification::new(&app.config().tauri.bundle.identifier)
        .title("The program is already running. Please do not start it again!")
        .body(cwd)
        .icon("pot")
        .show()
        .unwrap();
}))
```

**å­¦ä¹ è¦ç‚¹ï¼š**

1. âœ… æ£€æµ‹å·²è¿è¡Œå®ä¾‹
2. âœ… å‹å¥½æç¤ºç”¨æˆ·
3. âœ… ä¼ é€’å¯åŠ¨å‚æ•°åˆ°å·²è¿è¡Œå®ä¾‹ï¼ˆå¯é€‰ï¼‰

---

## 8. å›½é™…åŒ–æ”¯æŒ

### 8.1 å‰ç«¯å›½é™…åŒ–

**i18next é…ç½®ï¼š**

æ–‡ä»¶ï¼š`src/i18n/index.jsx`

```javascript
i18n.use(initReactI18next).init({
  fallbackLng: {
    zh_tw: ['zh_cn'],
    zh_cn: ['zh_tw'],
    pt_pt: ['pt_br'],
    pt_br: ['pt_pt'],
    default: ['en'],
  },
  debug: false,
  interpolation: {
    escapeValue: false, // React å·²ç»é˜²æ­¢ XSS
  },
  resources: {
    en: en_US,
    zh_cn: zh_CN,
    zh_tw: zh_TW,
    ja: ja_JP,
    // ... 20+ ç§è¯­è¨€
  },
})
```

**å›½é™…åŒ–æœ€ä½³å®è·µï¼š**

| ç‰¹æ€§              | è¯´æ˜                     | ä»£ç ç¤ºä¾‹                           |
| ----------------- | ------------------------ | ---------------------------------- |
| **Fallback è¯­è¨€** | æ‰¾ä¸åˆ°ç¿»è¯‘æ—¶ä½¿ç”¨å¤‡ç”¨è¯­è¨€ | `zh_tw â†’ zh_cn â†’ en`               |
| **æ’å€¼å®‰å…¨**      | React è‡ªåŠ¨è½¬ä¹‰ï¼Œé˜²æ­¢ XSS | `escapeValue: false`               |
| **å‘½åç©ºé—´**      | åˆ†æ¨¡å—ç®¡ç†ç¿»è¯‘           | `translation.config.general.title` |
| **å¤æ•°å½¢å¼**      | æ”¯æŒä¸åŒè¯­è¨€çš„å¤æ•°è§„åˆ™   | `{ count } items`                  |

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```javascript
// src/window/Config/index.jsx (65è¡Œ)
import { useTranslation } from 'react-i18next'

function ConfigPage() {
  const { t } = useTranslation()
  return <h2>{t(`config.${location.pathname.slice(1)}.title`)}</h2>
}
```

### 8.2 åç«¯å›½é™…åŒ–

**æ‰˜ç›˜èœå•å¤šè¯­è¨€ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/tray.rs` (206-595è¡Œ)

```rust
fn tray_menu_zh_cn() -> tauri::SystemTrayMenu {
    let input_translate = CustomMenuItem::new("input_translate", "è¾“å…¥ç¿»è¯‘");
    let config = CustomMenuItem::new("config", "åå¥½è®¾ç½®");
    let quit = CustomMenuItem::new("quit", "é€€å‡º");
    SystemTrayMenu::new()
        .add_item(input_translate)
        .add_item(config)
        .add_item(quit)
}

fn tray_menu_en() -> tauri::SystemTrayMenu {
    let input_translate = CustomMenuItem::new("input_translate", "Input Translate");
    let config = CustomMenuItem::new("config", "Config");
    let quit = CustomMenuItem::new("quit", "Quit");
    SystemTrayMenu::new()
        .add_item(input_translate)
        .add_item(config)
        .add_item(quit)
}
```

**æ”¯æŒçš„è¯­è¨€åˆ—è¡¨ï¼š**

| è¯­è¨€           | ä»£ç     | æ‰˜ç›˜èœå•å‡½æ•°        | å‰ç«¯èµ„æº     |
| -------------- | ------- | ------------------- | ------------ |
| è‹±è¯­           | `en`    | `tray_menu_en()`    | `en_US.json` |
| ç®€ä½“ä¸­æ–‡       | `zh_cn` | `tray_menu_zh_cn()` | `zh_CN.json` |
| ç¹ä½“ä¸­æ–‡       | `zh_tw` | `tray_menu_zh_tw()` | `zh_TW.json` |
| æ—¥è¯­           | `ja`    | `tray_menu_ja()`    | `ja_JP.json` |
| éŸ©è¯­           | `ko`    | `tray_menu_ko()`    | `ko_KR.json` |
| æ³•è¯­           | `fr`    | `tray_menu_fr()`    | `fr_FR.json` |
| å¾·è¯­           | `de`    | `tray_menu_de()`    | `de_DE.json` |
| ä¿„è¯­           | `ru`    | `tray_menu_ru()`    | `ru_RU.json` |
| è‘¡è„ç‰™è¯­(å·´è¥¿) | `pt_br` | `tray_menu_pt_br()` | `pt_BR.json` |
| æ³¢æ–¯è¯­         | `fa`    | `tray_menu_fa()`    | `fa_IR.json` |
| ä¹Œå…‹å…°è¯­       | `uk`    | `tray_menu_uk()`    | `uk_UA.json` |
| é˜¿æ‹‰ä¼¯è¯­       | `ar`    | -                   | `ar_AE.json` |
| å¸Œä¼¯æ¥è¯­       | `he`    | -                   | `he_IL.json` |

### 8.3 è¯­è¨€æ£€æµ‹

**æœ¬åœ°è¯­è¨€æ£€æµ‹ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/lang_detect.rs`

```rust
use lingua::{Language, LanguageDetectorBuilder};

#[tauri::command]
pub fn lang_detect(text: &str) -> Result<&str, ()> {
    let languages = vec![
        Language::Chinese,
        Language::Japanese,
        Language::English,
        Language::Korean,
        Language::French,
        Language::Spanish,
        // ... æ›´å¤šè¯­è¨€
    ];
    let detector = LanguageDetectorBuilder::from_languages(&languages).build();
    if let Some(lang) = detector.detect_language_of(text) {
        match lang {
            Language::Chinese => Ok("zh_cn"),
            Language::Japanese => Ok("ja"),
            Language::English => Ok("en"),
            // ...
            _ => Ok("en"),
        }
    } else {
        Ok("en")
    }
}
```

**å»¶è¿Ÿåˆå§‹åŒ–ä¼˜åŒ–ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/lang_detect.rs` (1-30è¡Œ)

```rust
pub fn init_lang_detect() {
    // åœ¨åº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–è¯­è¨€æ£€æµ‹å™¨
    // é¦–æ¬¡è°ƒç”¨è¾ƒæ…¢ï¼Œåç»­è°ƒç”¨å¿«é€Ÿ
    let detector = LanguageDetectorBuilder::from_languages(&languages).build();
    let _ = detector.detect_language_of("Hello Language"); // âœ… é¢„çƒ­
}
```

**å­¦ä¹ è¦ç‚¹è¡¨æ ¼ï¼š**

| ç‰¹æ€§           | å®ç°æ–¹å¼       | ä»£ç ä½ç½®                   | LightSync åº”ç”¨        |
| -------------- | -------------- | -------------------------- | --------------------- |
| **æœ¬åœ°è¯†åˆ«**   | lingua crate   | `lang_detect.rs` (4-28è¡Œ)  | âŒ ä¸éœ€è¦è¯­è¨€æ£€æµ‹     |
| **å»¶è¿Ÿåˆå§‹åŒ–** | å¯åŠ¨æ—¶é¢„çƒ­     | `lang_detect.rs` (1-30è¡Œ)  | â­â­â­â­ å‡å°‘å¯åŠ¨æ—¶é—´ |
| **æšä¸¾æ˜ å°„**   | match è¯­å¥è½¬æ¢ | `lang_detect.rs` (59-83è¡Œ) | â­â­â­ ç±»å‹å®‰å…¨       |
| **é»˜è®¤å€¼å¤„ç†** | Option å¤„ç†    | `lang_detect.rs` (84è¡Œ)    | â­â­â­â­â­ é˜²æ­¢å´©æºƒ   |

**å¯¹ LightSync çš„å¯ç¤ºï¼š**

- âœ… é‡å‹åˆå§‹åŒ–åœ¨å¯åŠ¨æ—¶å¼‚æ­¥é¢„çƒ­
- âœ… ä½¿ç”¨ `OnceCell` å®ç°å•ä¾‹æ¨¡å¼
- âœ… æä¾›åˆç†çš„é»˜è®¤å€¼é¿å…é”™è¯¯

---

## 9. çŠ¶æ€ç®¡ç†

### 9.1 Jotai åŸå­åŒ–çŠ¶æ€ç®¡ç†

**ä¸ºä»€ä¹ˆä½¿ç”¨ Jotaiï¼š**

æ–‡ä»¶ï¼š`package.json` (24è¡Œ)

| ç‰¹æ€§         | Jotai | Redux  | Zustand | é€‚ç”¨æ€§             |
| ------------ | ----- | ------ | ------- | ------------------ |
| **åŒ…ä½“ç§¯**   | 3KB   | 8KB    | 3KB     | âœ… è½»é‡çº§          |
| **å­¦ä¹ æˆæœ¬** | ä½    | é«˜     | ä¸­      | âœ… å¿«é€Ÿä¸Šæ‰‹        |
| **ç±»å‹å®‰å…¨** | å®Œç¾  | éœ€é…ç½® | å¾ˆå¥½    | âœ… TypeScript å‹å¥½ |
| **æ€§èƒ½**     | ä¼˜ç§€  | è‰¯å¥½   | ä¼˜ç§€    | âœ… ç»†ç²’åº¦æ›´æ–°      |
| **DevTools** | åŸºç¡€  | å®Œå–„   | åŸºç¡€    | âš ï¸ è°ƒè¯•å—é™        |

**Jotai åœ¨ pot-desktop ä¸­çš„åº”ç”¨æ¨¡å¼ï¼š**

è™½ç„¶ pot-desktop ä¸»è¦ä½¿ç”¨ `tauri-plugin-store` è¿›è¡ŒæŒä¹…åŒ–ï¼Œä½† Jotai é€‚åˆä¸´æ—¶çŠ¶æ€ç®¡ç†ã€‚

**æ¨èçš„çŠ¶æ€ç®¡ç†æ¶æ„ï¼š**

```javascript
// atoms/syncState.js (LightSync å»ºè®®)
import { atom } from 'jotai'

// åŒæ­¥çŠ¶æ€ atom
export const isSyncingAtom = atom(false)
export const syncProgressAtom = atom(0)
export const lastSyncTimeAtom = atom(null)
export const syncErrorAtom = atom(null)

// è®¡ç®— atom (è¡ç”ŸçŠ¶æ€)
export const syncStatusTextAtom = atom(get => {
  const isSyncing = get(isSyncingAtom)
  const progress = get(syncProgressAtom)
  if (isSyncing) {
    return `Syncing... ${progress}%`
  }
  const lastSync = get(lastSyncTimeAtom)
  return lastSync ? `Last sync: ${lastSync}` : 'Not synced yet'
})

// å¼‚æ­¥ atom (å‰¯ä½œç”¨)
export const triggerSyncAtom = atom(null, async (get, set, folderId) => {
  set(isSyncingAtom, true)
  set(syncErrorAtom, null)
  try {
    await invoke('sync_folder', { folderId })
    set(lastSyncTimeAtom, new Date())
  } catch (error) {
    set(syncErrorAtom, error.message)
  } finally {
    set(isSyncingAtom, false)
  }
})
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```javascript
import { useAtom, useAtomValue } from 'jotai'
import { isSyncingAtom, syncStatusTextAtom, triggerSyncAtom } from './atoms/syncState'

function SyncButton({ folderId }) {
  const [isSyncing, setIsSyncing] = useAtom(isSyncingAtom)
  const statusText = useAtomValue(syncStatusTextAtom)
  const [, triggerSync] = useAtom(triggerSyncAtom)

  return (
    <div>
      <button onClick={() => triggerSync(folderId)} disabled={isSyncing}>
        {statusText}
      </button>
    </div>
  )
}
```

### 9.2 æŒä¹…åŒ–çŠ¶æ€ç®¡ç†

**tauri-plugin-store æ·±åº¦ä½¿ç”¨ï¼š**

æ–‡ä»¶ï¼š`src/utils/store.js`

```javascript
import { Store } from 'tauri-plugin-store-api'
import { appConfigDir, join } from '@tauri-apps/api/path'
import { watch } from 'tauri-plugin-fs-watch-api'
import { invoke } from '@tauri-apps/api'

export let store = new Store()

export async function initStore() {
  const appConfigDirPath = await appConfigDir()
  const appConfigPath = await join(appConfigDirPath, 'config.json')
  store = new Store(appConfigPath)

  // âœ… ç›‘å¬é…ç½®æ–‡ä»¶å˜åŒ–ï¼Œå®æ—¶åŒæ­¥
  const _ = await watch(appConfigPath, async () => {
    await store.load()
    await invoke('reload_store') // é€šçŸ¥ Rust ç«¯é‡æ–°åŠ è½½
  })
}
```

**çŠ¶æ€åŒæ­¥æœºåˆ¶è¡¨ï¼š**

| åŒæ­¥æ–¹å‘        | è§¦å‘æ—¶æœº     | å®ç°æ–¹å¼                     | ä»£ç ä½ç½®                  |
| --------------- | ------------ | ---------------------------- | ------------------------- |
| **å‰ç«¯ â†’ Rust** | é…ç½®ä¿®æ”¹æ—¶   | `store.set() + store.save()` | `useConfig.jsx` (13-20è¡Œ) |
| **Rust â†’ å‰ç«¯** | æ–‡ä»¶ç›‘å¬å˜åŒ– | `watch()` + `store.load()`   | `store.js` (12-15è¡Œ)      |
| **è·¨çª—å£åŒæ­¥**  | æ–‡ä»¶å˜åŒ–äº‹ä»¶ | æ–‡ä»¶ç›‘å¬å¹¿æ’­                 | `store.js` (12-15è¡Œ)      |

**LightSync é…ç½®åŒæ­¥å»ºè®®ï¼š**

```javascript
// utils/syncConfig.js (å»ºè®®å®ç°)
export class SyncConfigManager {
  constructor() {
    this.listeners = new Map()
  }

  // ç›‘å¬ç‰¹å®šé…ç½®é”®å˜åŒ–
  async watch(key, callback) {
    if (!this.listeners.has(key)) {
      this.listeners.set(key, [])
    }
    this.listeners.get(key).push(callback)

    // è®¾ç½®æ–‡ä»¶ç›‘å¬å™¨
    await listen(`config_${key}_changed`, event => {
      this.listeners.get(key).forEach(cb => cb(event.payload))
    })
  }

  // æ›´æ–°é…ç½®å¹¶é€šçŸ¥
  async set(key, value) {
    await store.set(key, value)
    await store.save()
    await emit(`config_${key}_changed`, value)
  }
}
```

### 9.3 çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ

**çŠ¶æ€åˆ†å±‚æ¶æ„ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UI Component State (useState, useReducer)      â”‚ â† ä¸´æ—¶ UI çŠ¶æ€
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Global State (Jotai)                           â”‚ â† è¿è¡Œæ—¶å…¨å±€çŠ¶æ€
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Persistent State (tauri-plugin-store)          â”‚ â† æŒä¹…åŒ–é…ç½®
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Database (SQLite via tauri-plugin-sql)         â”‚ â† å¤§é‡ç»“æ„åŒ–æ•°æ®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€é€‰æ‹©å†³ç­–è¡¨ï¼š**

| çŠ¶æ€ç±»å‹        | å­˜å‚¨æ–¹æ¡ˆ | ç¤ºä¾‹                 | ç”Ÿå‘½å‘¨æœŸ         |
| --------------- | -------- | -------------------- | ---------------- |
| **UI ä¸´æ—¶çŠ¶æ€** | useState | å¼¹çª—å¼€å…³ã€è¾“å…¥æ¡†å†…å®¹ | ç»„ä»¶é”€æ¯æ—¶æ¸…é™¤   |
| **å…¨å±€è¿è¡Œæ—¶**  | Jotai    | åŒæ­¥è¿›åº¦ã€ç½‘ç»œçŠ¶æ€   | åº”ç”¨å…³é—­æ—¶æ¸…é™¤   |
| **ç”¨æˆ·é…ç½®**    | Store    | æœåŠ¡å™¨åœ°å€ã€ä¸»é¢˜è®¾ç½® | æ°¸ä¹…ä¿å­˜         |
| **å†å²è®°å½•**    | SQLite   | åŒæ­¥æ—¥å¿—ã€é”™è¯¯è®°å½•   | æ°¸ä¹…ä¿å­˜ï¼Œå¯æŸ¥è¯¢ |

---

## 10. UI/UX è®¾è®¡

### 10.1 NextUI + TailwindCSS è®¾è®¡ç³»ç»Ÿ

**æŠ€æœ¯æ ˆç»„åˆï¼š**

æ–‡ä»¶ï¼š`package.json` (15-16è¡Œ)

```json
{
  "dependencies": {
    "@nextui-org/react": "^2.4.8",
    "@nextui-org/theme": "^2.2.11",
    "tailwindcss": "^3.4.14",
    "framer-motion": "^11.11.10"
  }
}
```

**ç»„åˆä¼˜åŠ¿è¡¨ï¼š**

| æŠ€æœ¯              | ä½œç”¨       | ä¼˜åŠ¿                         | é€‚ç”¨åœºæ™¯           |
| ----------------- | ---------- | ---------------------------- | ------------------ |
| **NextUI**        | ç»„ä»¶åº“     | ç°ä»£åŒ–ã€å¯å®šåˆ¶ã€æ”¯æŒæ·±è‰²æ¨¡å¼ | æŒ‰é’®ã€è¡¨å•ã€å¡ç‰‡ç­‰ |
| **TailwindCSS**   | å®ç”¨ç±»æ¡†æ¶ | å¿«é€Ÿå¸ƒå±€ã€å“åº”å¼ã€å°ä½“ç§¯     | è‡ªå®šä¹‰å¸ƒå±€ã€é—´è·   |
| **Framer Motion** | åŠ¨ç”»åº“     | æµç•…åŠ¨ç”»ã€æ‰‹åŠ¿æ”¯æŒ           | é¡µé¢è¿‡æ¸¡ã€äº¤äº’åé¦ˆ |
| **next-themes**   | ä¸»é¢˜åˆ‡æ¢   | ç³»ç»Ÿä¸»é¢˜è·Ÿéš                 | æ·±è‰²/æµ…è‰²æ¨¡å¼      |

### 10.2 å“åº”å¼å¸ƒå±€è®¾è®¡

**é…ç½®ç•Œé¢å¸ƒå±€å®ç°ï¼š**

æ–‡ä»¶ï¼š`src/window/Config/index.jsx`

```jsx
export default function Config() {
  const [transparent] = useConfig('transparent', true)
  const location = useLocation()

  return (
    <>
      {/* ä¾§è¾¹æ  */}
      <Card
        shadow="none"
        className={`${transparent ? 'bg-background/90' : 'bg-content1'} float-left h-screen w-[230px] rounded-none ${
          osType === 'Linux' && 'rounded-l-[10px] border-1'
        } cursor-default select-none border-r-1 border-default-100`}
      >
        {/* Logo å’Œå¯æ‹–åŠ¨åŒºåŸŸ */}
        <div className="h-[35px] p-[5px]">
          <div className="h-full w-full" data-tauri-drag-region="true" />
        </div>

        <SideBar />
      </Card>

      {/* ä¸»å†…å®¹åŒº */}
      <div className={`ml-[230px] h-screen bg-background`}>
        {/* æ ‡é¢˜æ  */}
        <div className="flex h-[35px] justify-between">
          <h2>{t(`config.${location.pathname.slice(1)}.title`)}</h2>
          {osType !== 'Darwin' && <WindowControl />}
        </div>

        {/* æ»šåŠ¨å†…å®¹ */}
        <div className="h-[calc(100vh-36px)] overflow-y-auto p-[10px]">{page}</div>
      </div>
    </>
  )
}
```

**å¸ƒå±€è®¾è®¡è¦ç‚¹è¡¨ï¼š**

| è®¾è®¡è¦ç‚¹         | å®ç°æ–¹å¼                      | ä»£ç ä½ç½®                      | å­¦ä¹ ä»·å€¼   |
| ---------------- | ----------------------------- | ----------------------------- | ---------- |
| **å›ºå®šä¾§è¾¹æ **   | `float-left w-[230px]`        | `Config/index.jsx` (28-35è¡Œ)  | â­â­â­â­â­ |
| **è‡ªå®šä¹‰æ‹–åŠ¨åŒº** | `data-tauri-drag-region`      | `Config/index.jsx` (36-40è¡Œ)  | â­â­â­â­â­ |
| **å¹³å°å·®å¼‚åŒ–**   | æ¡ä»¶æ¸²æŸ“ `osType === 'Linux'` | `Config/index.jsx` (33, 56è¡Œ) | â­â­â­â­â­ |
| **é€æ˜èƒŒæ™¯**     | `bg-background/90`            | `Config/index.jsx` (31è¡Œ)     | â­â­â­â­   |
| **è®¡ç®—é«˜åº¦**     | `h-[calc(100vh-36px)]`        | `Config/index.jsx` (72-74è¡Œ)  | â­â­â­â­   |

### 10.3 ä¸»é¢˜ç³»ç»Ÿå®ç°

**ä¸»é¢˜åˆ‡æ¢ Hookï¼š**

æ–‡ä»¶ï¼š`src/hooks/useToastStyle.jsx`

```javascript
import { semanticColors } from '@nextui-org/theme'
import { useTheme } from 'next-themes'

export const useToastStyle = () => {
  const { theme } = useTheme()

  const toastStyle = {
    background: theme == 'dark' ? semanticColors.dark.content1.DEFAULT : semanticColors.light.content1.DEFAULT,
    color: theme == 'dark' ? semanticColors.dark.foreground.DEFAULT : semanticColors.light.foreground.DEFAULT,
    wordBreak: 'break-all',
  }

  return toastStyle
}
```

**ä¸»é¢˜ç³»ç»Ÿè®¾è®¡è¡¨ï¼š**

| åŠŸèƒ½             | å®ç°æ–¹å¼               | ä¼˜åŠ¿               | ä»£ç ç¤ºä¾‹                       |
| ---------------- | ---------------------- | ------------------ | ------------------------------ |
| **ç³»ç»Ÿä¸»é¢˜è·Ÿéš** | `next-themes`          | è‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿè®¾ç½®   | `useTheme()`                   |
| **è¯­ä¹‰åŒ–é¢œè‰²**   | NextUI semantic colors | ä¸»é¢˜åˆ‡æ¢æ—¶è‡ªåŠ¨é€‚é… | `semanticColors.dark.content1` |
| **æ¡ä»¶æ ·å¼**     | ä¸‰å…ƒè¿ç®—ç¬¦             | åŠ¨æ€åˆ‡æ¢æ ·å¼       | `theme == 'dark' ? ... : ...`  |

**LightSync ä¸»é¢˜é…ç½®å»ºè®®ï¼š**

```javascript
// themes/syncTheme.js
export const syncTheme = {
  light: {
    primary: '#0070F0', // è“è‰² - åŒæ­¥è¿›è¡Œä¸­
    success: '#17C964', // ç»¿è‰² - åŒæ­¥æˆåŠŸ
    warning: '#F5A524', // æ©™è‰² - è­¦å‘Š
    danger: '#F31260', // çº¢è‰² - åŒæ­¥å¤±è´¥
    background: '#FFFFFF',
    foreground: '#11181C',
  },
  dark: {
    primary: '#0072F5',
    success: '#17C964',
    warning: '#F5A524',
    danger: '#F31260',
    background: '#000000',
    foreground: '#ECEDEE',
  },
}
```

### 10.4 äº¤äº’åé¦ˆè®¾è®¡

**Toast é€šçŸ¥ç³»ç»Ÿï¼š**

æ–‡ä»¶ï¼š`package.json` (33è¡Œ)

```json
"react-hot-toast": "^2.4.1"
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```javascript
import toast from 'react-hot-toast'
import { useToastStyle } from './hooks/useToastStyle'

function SyncNotification() {
  const toastStyle = useToastStyle()

  const notifySyncSuccess = () => {
    toast.success('Sync completed!', {
      style: toastStyle,
      duration: 3000,
      position: 'bottom-right',
    })
  }

  const notifySyncError = error => {
    toast.error(`Sync failed: ${error}`, {
      style: toastStyle,
      duration: 5000,
    })
  }
}
```

**äº¤äº’åé¦ˆå±‚çº§è¡¨ï¼š**

| å±‚çº§        | äº¤äº’ç±»å‹ | å®ç°æ–¹å¼             | ä½¿ç”¨åœºæ™¯           |
| ----------- | -------- | -------------------- | ------------------ |
| **Level 1** | å¾®äº¤äº’   | Hover æ•ˆæœã€æŒ‰é’®æŒ‰ä¸‹ | æ‰€æœ‰å¯äº¤äº’å…ƒç´      |
| **Level 2** | çŠ¶æ€åé¦ˆ | åŠ è½½åŠ¨ç”»ã€è¿›åº¦æ¡     | åŒæ­¥è¿›è¡Œä¸­         |
| **Level 3** | ç»“æœé€šçŸ¥ | Toast æ¶ˆæ¯           | æ“ä½œæˆåŠŸ/å¤±è´¥      |
| **Level 4** | æ¨¡æ€ç¡®è®¤ | Dialog å¯¹è¯æ¡†        | åˆ é™¤æ“ä½œã€å†²çªè§£å†³ |

### 10.5 æ— éšœç¢è®¾è®¡

**é”®ç›˜å¯¼èˆªæ”¯æŒï¼š**

```jsx
// å¯è®¿é—®æ€§æœ€ä½³å®è·µ
<Button
  aria-label="Sync folder"
  onKeyDown={e => {
    if (e.key === 'Enter' || e.key === ' ') {
      handleSync()
    }
  }}
>
  Sync
</Button>
```

**æ— éšœç¢æ£€æŸ¥æ¸…å•ï¼š**

| é¡¹ç›®            | è¦æ±‚           | å®ç°æ–¹å¼                         |
| --------------- | -------------- | -------------------------------- |
| **è¯­ä¹‰åŒ– HTML** | ä½¿ç”¨æ­£ç¡®çš„å…ƒç´  | `<button>` è€Œé `<div onClick>`  |
| **é”®ç›˜å¯¼èˆª**    | Tab é”®å¯èšç„¦   | `tabIndex` å±æ€§                  |
| **å±å¹•é˜…è¯»å™¨**  | ARIA æ ‡ç­¾      | `aria-label`, `aria-describedby` |
| **é¢œè‰²å¯¹æ¯”åº¦**  | WCAG AA æ ‡å‡†   | è‡³å°‘ 4.5:1 å¯¹æ¯”åº¦                |
| **ç„¦ç‚¹æŒ‡ç¤ºå™¨**  | å¯è§ç„¦ç‚¹æ ·å¼   | `:focus-visible` æ ·å¼            |

---

## 11. æ›´æ–°æœºåˆ¶

### 11.1 Tauri Updater é…ç½®

**æ›´æ–°é…ç½®ï¼š**

æ–‡ä»¶ï¼š`src-tauri/tauri.conf.json` (123-131è¡Œ)

```json
{
  "updater": {
    "active": true,
    "dialog": false,
    "endpoints": [
      "https://dl.pot-app.com/https://github.com/pot-app/pot-desktop/releases/download/updater/update.json",
      "https://github.com/pot-app/pot-desktop/releases/download/updater/update.json"
    ],
    "pubkey": "dW50cnVzdGVkIGNvbW1lbnQ6..."
  }
}
```

**æ›´æ–°æœºåˆ¶è¯¦è§£è¡¨ï¼š**

| é…ç½®é¡¹        | è¯´æ˜               | pot-desktop é…ç½® | LightSync å»ºè®®  |
| ------------- | ------------------ | ---------------- | --------------- |
| **active**    | å¯ç”¨æ›´æ–°åŠŸèƒ½       | `true`           | âœ… ä¿æŒå¯ç”¨     |
| **dialog**    | æ˜¾ç¤ºå†…ç½®æ›´æ–°å¯¹è¯æ¡† | `false`          | `true` ç®€åŒ–å®ç° |
| **endpoints** | æ›´æ–°æœåŠ¡å™¨åˆ—è¡¨     | å¤šä¸ªå¤‡ç”¨åœ°å€     | âœ… å›½å†…å¤–é•œåƒ   |
| **pubkey**    | å…¬é’¥ç­¾åéªŒè¯       | minisign å…¬é’¥    | âœ… é˜²æ­¢ç¯¡æ”¹     |

### 11.2 æ›´æ–°æ£€æŸ¥å®ç°

**è‡ªåŠ¨æ›´æ–°æ£€æŸ¥ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/updater.rs`

```rust
use crate::config::{get, set};
use crate::window::updater_window;
use log::{info, warn};

pub fn check_update(app_handle: tauri::AppHandle) {
    // è¯»å–ç”¨æˆ·é…ç½®ï¼šæ˜¯å¦å¯ç”¨æ›´æ–°æ£€æŸ¥
    let enable = match get("check_update") {
        Some(v) => v.as_bool().unwrap(),
        None => {
            set("check_update", true); // é»˜è®¤å¯ç”¨
            true
        }
    };

    if enable {
        // å¼‚æ­¥æ£€æŸ¥æ›´æ–°ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
        tauri::async_runtime::spawn(async move {
            match tauri::updater::builder(app_handle).check().await {
                Ok(update) => {
                    if update.is_update_available() {
                        info!("New version available");
                        updater_window(); // æ˜¾ç¤ºæ›´æ–°çª—å£
                    }
                }
                Err(e) => {
                    warn!("Failed to check update: {}", e);
                }
            }
        });
    }
}
```

**æ›´æ–°æ£€æŸ¥ç­–ç•¥è¡¨ï¼š**

| ç­–ç•¥         | è§¦å‘æ—¶æœº       | å®ç°æ–¹å¼                      | ä»£ç ä½ç½®               |
| ------------ | -------------- | ----------------------------- | ---------------------- |
| **å¯åŠ¨æ£€æŸ¥** | åº”ç”¨å¯åŠ¨æ—¶     | `check_update(app_handle)`    | `main.rs` å¯åŠ¨æ—¶è°ƒç”¨   |
| **å¼‚æ­¥æ‰§è¡Œ** | åå°è¿è¡Œ       | `tauri::async_runtime::spawn` | `updater.rs` (14è¡Œ)    |
| **ç”¨æˆ·æ§åˆ¶** | é…ç½®å¼€å…³       | `check_update` é…ç½®é¡¹         | `updater.rs` (6-12è¡Œ)  |
| **é™é»˜å¤±è´¥** | é”™è¯¯ä¸æ‰“æ‰°ç”¨æˆ· | `warn!` ä»…è®°å½•æ—¥å¿—            | `updater.rs` (22-24è¡Œ) |

### 11.3 æ›´æ–° JSON æ ¼å¼

**update.json è§„èŒƒï¼š**

```json
{
  "version": "3.0.7",
  "notes": "Bug fixes and performance improvements",
  "pub_date": "2024-01-15T10:00:00Z",
  "platforms": {
    "darwin-x86_64": {
      "signature": "base64_signature_here",
      "url": "https://github.com/pot-app/pot-desktop/releases/download/3.0.7/pot_3.0.7_x64.app.tar.gz"
    },
    "darwin-aarch64": {
      "signature": "base64_signature_here",
      "url": "https://github.com/pot-app/pot-desktop/releases/download/3.0.7/pot_3.0.7_aarch64.app.tar.gz"
    },
    "windows-x86_64": {
      "signature": "base64_signature_here",
      "url": "https://github.com/pot-app/pot-desktop/releases/download/3.0.7/pot_3.0.7_x64_en-US.msi.zip"
    },
    "linux-x86_64": {
      "signature": "base64_signature_here",
      "url": "https://github.com/pot-app/pot-desktop/releases/download/3.0.7/pot_3.0.7_amd64.AppImage.tar.gz"
    }
  }
}
```

### 11.4 ç­¾åä¸å®‰å…¨

**ç”Ÿæˆç­¾åå¯†é’¥ï¼š**

```bash
# ä½¿ç”¨ minisign å·¥å…·ç”Ÿæˆå¯†é’¥å¯¹
minisign -G

# ç”Ÿæˆæ–‡ä»¶ï¼š
# - minisign.key (ç§é’¥ï¼Œä¿å¯†ï¼)
# - minisign.pub (å…¬é’¥ï¼Œæ”¾å…¥ tauri.conf.json)
```

**ç­¾åæ›´æ–°åŒ…ï¼š**

```bash
# ä¸ºæ›´æ–°åŒ…ç­¾å
minisign -S -m update.json -s minisign.key
# ç”Ÿæˆ update.json.minisig ç­¾åæ–‡ä»¶
```

**å®‰å…¨æ›´æ–°æµç¨‹è¡¨ï¼š**

| æ­¥éª¤            | æ“ä½œ             | éªŒè¯ç‚¹        | å®‰å…¨ä¿éšœ       |
| --------------- | ---------------- | ------------- | -------------- |
| **1. æ£€æŸ¥æ›´æ–°** | è¯·æ±‚ update.json | HTTPS éªŒè¯    | é˜²æ­¢ä¸­é—´äººæ”»å‡» |
| **2. éªŒè¯ç­¾å** | ä½¿ç”¨ pubkey éªŒè¯ | minisign ç­¾å | é˜²æ­¢æ–‡ä»¶ç¯¡æ”¹   |
| **3. ä¸‹è½½æ›´æ–°** | ä¸‹è½½æ›´æ–°åŒ…       | å†æ¬¡éªŒè¯ç­¾å  | ç¡®ä¿å®Œæ•´æ€§     |
| **4. å®‰è£…æ›´æ–°** | è¦†ç›–æ—§æ–‡ä»¶       | åŸå­æ“ä½œ      | é˜²æ­¢æ›´æ–°ä¸­æ–­   |

---

## 12. æ–‡ä»¶å¤‡ä»½ä¸åŒæ­¥

### 12.1 WebDAV å®ç°

**WebDAV æ“ä½œå°è£…ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/backup.rs`

```rust
use reqwest_dav::{Auth, ClientBuilder, Depth};

#[tauri::command(async)]
pub async fn webdav(
    operate: &str,
    url: String,
    username: String,
    password: String,
    name: Option<String>,
) -> Result<String, Error> {
    // æ„å»º WebDAV å®¢æˆ·ç«¯
    let client = ClientBuilder::new()
        .set_host(url.clone())
        .set_auth(Auth::Basic(username.clone(), password.clone()))
        .build()?;

    // åˆ›å»ºæ ¹ç›®å½•
    client.mkcol("/pot-app").await.unwrap_or_default();

    // åˆ‡æ¢åˆ°åº”ç”¨ç›®å½•
    let client = ClientBuilder::new()
        .set_host(format!("{}/pot-app", url.trim_end_matches("/")))
        .set_auth(Auth::Basic(username, password))
        .build()?;

    match operate {
        "list" => {
            let res = client.list("/", Depth::Number(1)).await?;
            Ok(serde_json::to_string(&res)?)
        }
        "get" => {
            // ä¸‹è½½å¤‡ä»½
            let res = client.get(&format!("/{}", name.unwrap())).await?;
            let data = res.bytes().await?;
            // è§£å‹åˆ°é…ç½®ç›®å½•
            // ...
        }
        "put" => {
            // æ‰“åŒ…é…ç½®æ–‡ä»¶
            // ä¸Šä¼ åˆ° WebDAV
            // ...
        }
        "delete" => {
            client.delete(&format!("/{}", name.unwrap())).await?;
            Ok("".to_string())
        }
        _ => Err(Error::Error("Invalid operation".into())),
    }
}
```

**WebDAV æ“ä½œè¡¨ï¼š**

| æ“ä½œ       | HTTP æ–¹æ³• | ç”¨é€”         | ä»£ç ä½ç½®                |
| ---------- | --------- | ------------ | ----------------------- |
| **list**   | PROPFIND  | åˆ—å‡ºè¿œç¨‹å¤‡ä»½ | `backup.rs` (29-32è¡Œ)   |
| **get**    | GET       | ä¸‹è½½æ¢å¤å¤‡ä»½ | `backup.rs` (34-46è¡Œ)   |
| **put**    | PUT       | ä¸Šä¼ å¤‡ä»½     | `backup.rs` (48-98è¡Œ)   |
| **delete** | DELETE    | åˆ é™¤å¤‡ä»½     | `backup.rs` (101-106è¡Œ) |
| **mkcol**  | MKCOL     | åˆ›å»ºç›®å½•     | `backup.rs` (23è¡Œ)      |

### 12.2 å¤‡ä»½æ‰“åŒ…ç­–ç•¥

**ZIP æ‰“åŒ…å®ç°ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/backup.rs` (48-98è¡Œ)

```rust
use zip::write::SimpleFileOptions;
use walkdir::WalkDir;

// åˆ›å»ºå¤‡ä»½åŒ…
let zip_file = std::fs::File::create(&zip_path)?;
let mut zip = zip::ZipWriter::new(zip_file);
let options = SimpleFileOptions::default()
    .compression_method(zip::CompressionMethod::Stored);

// æ·»åŠ é…ç½®æ–‡ä»¶
zip.start_file("config.json", options)?;
zip.write(&std::fs::read(&config_path)?)?;

// æ·»åŠ æ•°æ®åº“ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
if database_path.exists() {
    zip.start_file("history.db", options)?;
    zip.write(&std::fs::read(&database_path)?)?;
}

// é€’å½’æ·»åŠ æ’ä»¶ç›®å½•
if plugin_path.exists() {
    for entry in WalkDir::new(plugin_path) {
        let entry = entry?;
        let path = entry.path();
        if path.is_file() {
            let file_name = path.strip_prefix(&config_dir_path)?.to_str().unwrap();
            zip.start_file(file_name, options)?;
            zip.write(&std::fs::read(path)?)?;
        }
    }
}

zip.finish()?;
```

**å¤‡ä»½å†…å®¹æ¸…å•è¡¨ï¼š**

| æ–‡ä»¶ç±»å‹       | è·¯å¾„          | å¿…å¤‡æ€§    | å¤§å°ä¼°ç®— |
| -------------- | ------------- | --------- | -------- |
| **é…ç½®æ–‡ä»¶**   | `config.json` | âœ… å¿…é¡»   | <100KB   |
| **å†å²æ•°æ®åº“** | `history.db`  | âš ï¸ å¯é€‰   | 1-10MB   |
| **æ’ä»¶ç›®å½•**   | `plugins/`    | âš ï¸ å¯é€‰   | 10-100MB |
| **ç¼“å­˜æ–‡ä»¶**   | `cache/`      | âŒ ä¸å¤‡ä»½ | -        |

**LightSync å¤‡ä»½å»ºè®®ï¼š**

```rust
// å»ºè®®çš„ LightSync å¤‡ä»½å†…å®¹
pub struct BackupContent {
    pub config: ConfigData,           // æœåŠ¡å™¨é…ç½®ã€åŒæ­¥é…ç½®
    pub sync_cache: SyncCacheData,    // æ–‡ä»¶å…ƒæ•°æ®ç¼“å­˜
    pub exclude: Vec<PathBuf>,        // æ’é™¤ä¸´æ—¶æ–‡ä»¶
}

impl BackupContent {
    pub fn should_backup(&self, path: &Path) -> bool {
        // æ’é™¤è§„åˆ™
        let exclude_patterns = vec![
            ".DS_Store",
            "Thumbs.db",
            "*.tmp",
            "*.log",
        ];

        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åº”è¯¥å¤‡ä»½
        !exclude_patterns.iter().any(|p| path.matches(p))
    }
}
```

### 12.3 äº‘å­˜å‚¨é›†æˆ

**å¤šç§å¤‡ä»½æ–¹æ¡ˆæ”¯æŒï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/backup.rs`

| æ–¹æ¡ˆ           | å‡½æ•°       | åè®®         | é€‚ç”¨åœºæ™¯          |
| -------------- | ---------- | ------------ | ----------------- |
| **WebDAV**     | `webdav()` | WebDAV       | åšæœäº‘ã€NextCloud |
| **æœ¬åœ°å¤‡ä»½**   | `local()`  | File I/O     | æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ      |
| **é˜¿é‡Œäº‘ OSS** | `aliyun()` | HTTP PUT/GET | é˜¿é‡Œäº‘å¯¹è±¡å­˜å‚¨    |

**é˜¿é‡Œäº‘ OSS å®ç°ç¤ºä¾‹ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/backup.rs` (178-209è¡Œ)

```rust
#[tauri::command(async)]
pub async fn aliyun(operate: &str, path: String, url: String) -> Result<String, Error> {
    match operate {
        "put" => {
            // ä½¿ç”¨ PUT è¯·æ±‚ä¸Šä¼ æ–‡ä»¶
            let _ = reqwest::Client::new()
                .put(&url)  // é˜¿é‡Œäº‘ OSS ç­¾å URL
                .body(std::fs::read(&path)?)
                .send()
                .await?;
            Ok("".to_string())
        }
        "get" => {
            // ä½¿ç”¨ GET è¯·æ±‚ä¸‹è½½æ–‡ä»¶
            let res = reqwest::Client::new().get(&url).send().await?;
            let data = res.bytes().await?;

            // ä¿å­˜å¹¶è§£å‹
            let zip_path = config_dir_path.join("archive.zip");
            let mut zip_file = std::fs::File::create(&zip_path)?;
            zip_file.write_all(&data)?;

            // è§£å‹åˆ°é…ç½®ç›®å½•
            let mut zip_file = std::fs::File::open(&zip_path)?;
            let mut zip = ZipArchive::new(&mut zip_file)?;
            zip.extract(config_dir_path)?;

            Ok("".to_string())
        }
        _ => Err(Error::Error("Invalid operation".into())),
    }
}
```

**äº‘å­˜å‚¨æ‰©å±•å»ºè®®ï¼ˆLightSyncï¼‰ï¼š**

```rust
// å»ºè®®çš„ç»Ÿä¸€äº‘å­˜å‚¨æ¥å£
pub trait CloudStorage {
    async fn upload(&self, local_path: &Path, remote_path: &str) -> Result<()>;
    async fn download(&self, remote_path: &str, local_path: &Path) -> Result<()>;
    async fn list(&self, remote_dir: &str) -> Result<Vec<FileInfo>>;
    async fn delete(&self, remote_path: &str) -> Result<()>;
}

// WebDAV å®ç°
pub struct WebDavStorage { /* ... */ }
impl CloudStorage for WebDavStorage { /* ... */ }

// é˜¿é‡Œäº‘ OSS å®ç°
pub struct AliyunOssStorage { /* ... */ }
impl CloudStorage for AliyunOssStorage { /* ... */ }

// AWS S3 å®ç°
pub struct AwsS3Storage { /* ... */ }
impl CloudStorage for AwsS3Storage { /* ... */ }
```

---

## 13. æ„å»ºä¸æ‰“åŒ…

### 13.1 Vite æ„å»ºé…ç½®

**å¤šå…¥å£æ„å»ºï¼š**

æ–‡ä»¶ï¼š`vite.config.js`

```javascript
import react from '@vitejs/plugin-react'
import { defineConfig } from 'vite'
import { resolve } from 'path'

export default defineConfig(async () => ({
  plugins: [react()],

  clearScreen: false, // ä¸æ¸…å±ï¼ŒæŸ¥çœ‹ Rust é”™è¯¯

  server: {
    port: 1420,
    strictPort: true, // ç«¯å£å¿…é¡»å¯ç”¨
  },

  envPrefix: ['VITE_', 'TAURI_'], // ç¯å¢ƒå˜é‡å‰ç¼€

  build: {
    rollupOptions: {
      input: {
        index: resolve(__dirname, 'index.html'), // ä¸»çª—å£
        daemon: resolve(__dirname, 'daemon.html'), // å®ˆæŠ¤è¿›ç¨‹çª—å£
      },
    },
    // æ ¹æ®å¹³å°é€‰æ‹©ç›®æ ‡æµè§ˆå™¨
    target:
      process.env.TAURI_PLATFORM == 'windows'
        ? 'chrome105' // Windows WebView2
        : 'safari11', // macOS WKWebView

    // Debug æ¨¡å¼ä¸å‹ç¼©
    minify: !process.env.TAURI_DEBUG ? 'esbuild' : false,

    // Debug æ¨¡å¼ç”Ÿæˆ sourcemap
    sourcemap: !!process.env.TAURI_DEBUG,
  },
}))
```

**æ„å»ºä¼˜åŒ–é…ç½®è¡¨ï¼š**

| é…ç½®é¡¹          | ç”Ÿäº§ç¯å¢ƒ  | å¼€å‘ç¯å¢ƒ | åŸå›                |
| --------------- | --------- | -------- | ------------------ |
| **minify**      | `esbuild` | `false`  | å¼€å‘æ—¶ä¿ç•™å¯è¯»æ€§   |
| **sourcemap**   | `false`   | `true`   | å¼€å‘æ—¶ä¾¿äºè°ƒè¯•     |
| **target**      | å¹³å°ç›¸å…³  | å¹³å°ç›¸å…³ | åŒ¹é… WebView ç‰ˆæœ¬  |
| **clearScreen** | `false`   | `false`  | æŸ¥çœ‹ Rust ç¼–è¯‘é”™è¯¯ |

### 13.2 Cargo æ„å»ºé…ç½®

**æ€§èƒ½ä¼˜åŒ–é…ç½®ï¼š**

æ–‡ä»¶ï¼š`src-tauri/Cargo.toml`

```toml
[package]
name = "pot"
version = "0.0.0"
edition = "2021"

[dependencies]
tauri = { version = "1.8", features = [
    "dialog-save",
    "dialog-open",
    "fs-all",
    "protocol-asset",
    "shell-all",
    "clipboard-all",
    "http-all",
    "updater",
    "notification-all",
    "global-shortcut-all",
    "window-all",
    "system-tray",
    "devtools"
] }

# æ’ä»¶
tauri-plugin-single-instance = { git = "https://github.com/tauri-apps/plugins-workspace", branch = "v1" }
tauri-plugin-autostart = { git = "https://github.com/tauri-apps/plugins-workspace", branch = "v1" }
tauri-plugin-store = { git = "https://github.com/tauri-apps/plugins-workspace", branch = "v1" }
tauri-plugin-log = { git = "https://github.com/tauri-apps/plugins-workspace", branch = "v1" }
tauri-plugin-sql = { git= "https://github.com/tauri-apps/plugins-workspace", branch = "v1", features = ["sqlite"] }

# æ ¸å¿ƒåº“
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
once_cell = "1.19.0"
log = "0.4"
thiserror = "1.0"

# WebDAV å’Œç½‘ç»œ
reqwest = { version = "0.12", features = ["json"] }
reqwest_dav = "=0.1.5"

# æ–‡ä»¶å¤„ç†
zip = "2.2.0"
walkdir = "2.5"

# å¹³å°ç‰¹å®šä¾èµ–
[target.'cfg(target_os = "macos")'.dependencies]
window-shadows = "0.2"

[target.'cfg(windows)'.dependencies]
windows = { version="0.58.0", features= [
    "Win32_UI_WindowsAndMessaging",
    "Win32_Foundation"
] }
window-shadows = "0.2"

# æ„å»ºé…ç½®
[profile.dev]
opt-level = 0
debug = true

[profile.release]
opt-level = 3
lto = true
codegen-units = 1
strip = true
```

**ä¾èµ–ç®¡ç†æœ€ä½³å®è·µè¡¨ï¼š**

| å®è·µ             | è¯´æ˜                   | ç¤ºä¾‹                                   | å­¦ä¹ ä»·å€¼            |
| ---------------- | ---------------------- | -------------------------------------- | ------------------- |
| **Feature æ§åˆ¶** | åªå¯ç”¨éœ€è¦çš„åŠŸèƒ½       | `tauri = { features = ["fs-all"] }`    | â­â­â­â­â­ å‡å°ä½“ç§¯ |
| **ç‰ˆæœ¬é”å®š**     | é”å®šç‰¹å®šç‰ˆæœ¬           | `reqwest_dav = "=0.1.5"`               | â­â­â­â­ ç¨³å®šæ€§     |
| **å¹³å°æ¡ä»¶ç¼–è¯‘** | ä»…åœ¨ç‰¹å®šå¹³å°ç¼–è¯‘       | `[target.'cfg(windows)'.dependencies]` | â­â­â­â­â­ è·¨å¹³å°   |
| **LTO ä¼˜åŒ–**     | Link Time Optimization | `lto = true`                           | â­â­â­â­ æ€§èƒ½æå‡   |
| **Strip ç¬¦å·**   | ç§»é™¤è°ƒè¯•ç¬¦å·           | `strip = true`                         | â­â­â­â­ å‡å°ä½“ç§¯   |

### 13.3 æ‰“åŒ…é…ç½®

**Tauri Bundle é…ç½®ï¼š**

æ–‡ä»¶ï¼š`src-tauri/tauri.conf.json` (65-104è¡Œ)

```json
{
  "bundle": {
    "active": true,
    "category": "Utility",
    "copyright": "GPLv3",
    "targets": "all",
    "identifier": "com.pot-app.desktop",
    "longDescription": "A cross-platform text translation and ocr software",
    "shortDescription": "Pot App",
    "externalBin": [],
    "resources": [],
    "icon": [
      "icons/32x32.png",
      "icons/128x128.png",
      "icons/128x128@2x.png",
      "icons/icon.icns", // macOS
      "icons/icon.ico" // Windows
    ],
    "deb": {
      "depends": ["libxdo-dev", "libxcb1", "libxrandr2", "tesseract-ocr"]
    },
    "macOS": {
      "entitlements": null,
      "frameworks": [],
      "signingIdentity": null
    },
    "windows": {
      "certificateThumbprint": null,
      "digestAlgorithm": "sha256",
      "timestampUrl": ""
    }
  }
}
```

**æ‰“åŒ…ç›®æ ‡å¹³å°è¡¨ï¼š**

| å¹³å°        | æ‰“åŒ…æ ¼å¼           | é…ç½®ä½ç½®          | æ³¨æ„äº‹é¡¹                  |
| ----------- | ------------------ | ----------------- | ------------------------- |
| **Windows** | MSI, NSIS          | `tauri.conf.json` | éœ€è¦ä»£ç ç­¾åè¯ä¹¦          |
| **macOS**   | DMG, PKG           | `tauri.conf.json` | éœ€è¦ Apple Developer è´¦å· |
| **Linux**   | deb, rpm, AppImage | `deb.depends`     | æ³¨æ˜ç³»ç»Ÿä¾èµ–              |

### 13.4 CI/CD é…ç½®

**GitHub Actions å·¥ä½œæµå»ºè®®ï¼š**

```yaml
# .github/workflows/build.yml
name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    strategy:
      matrix:
        platform: [macos-latest, ubuntu-20.04, windows-latest]

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies (Ubuntu)
        if: matrix.platform == 'ubuntu-20.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.0-dev \
            build-essential \
            curl \
            wget \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build application
        run: pnpm tauri build

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: app-${{ matrix.platform }}
          path: src-tauri/target/release/bundle/
```

**æ„å»ºæµç¨‹æ£€æŸ¥è¡¨ï¼š**

| é˜¶æ®µ         | æ£€æŸ¥é¡¹          | å·¥å…·             | è‡ªåŠ¨åŒ–        |
| ------------ | --------------- | ---------------- | ------------- |
| **ä»£ç æ£€æŸ¥** | Lintã€Format    | Prettier, Clippy | âœ… Pre-commit |
| **å•å…ƒæµ‹è¯•** | å‡½æ•°é€»è¾‘æµ‹è¯•    | `cargo test`     | âœ… CI         |
| **é›†æˆæµ‹è¯•** | ç«¯åˆ°ç«¯æµ‹è¯•      | Playwright       | âš ï¸ åŠè‡ªåŠ¨     |
| **æ€§èƒ½æµ‹è¯•** | å†…å­˜ã€CPU ç›‘æ§  | æ€§èƒ½åˆ†æå·¥å…·     | âŒ æ‰‹åŠ¨       |
| **æ‰“åŒ…ç­¾å** | ä»£ç ç­¾å        | Certificates     | âœ… CI         |
| **å‘å¸ƒä¸Šä¼ ** | GitHub Releases | gh CLI           | âœ… CI         |

---

## ğŸ“ æ€»ç»“ä¸å­¦ä¹ è·¯å¾„å»ºè®®

### å…³é”®å­¦ä¹ ç‚¹æ±‡æ€»

**ğŸ”´ P0 - å¿…é¡»æŒæ¡ï¼ˆLightSync é¡¹ç›®æ ¸å¿ƒï¼‰ï¼š**

| æŠ€æœ¯ç‚¹                 | æ–‡ä»¶ä½ç½®                      | å­¦ä¹ ä»·å€¼   | åº”ç”¨åœºæ™¯     |
| ---------------------- | ----------------------------- | ---------- | ------------ |
| **Tauri æœ€å°æƒé™é…ç½®** | `tauri.conf.json` (14-63è¡Œ)   | â­â­â­â­â­ | å®‰å…¨æ€§åŸºç¡€   |
| **é…ç½®æŒä¹…åŒ–ç®¡ç†**     | `config.rs` + `useConfig.jsx` | â­â­â­â­â­ | ç”¨æˆ·é…ç½®ä¿å­˜ |
| **ç»Ÿä¸€é”™è¯¯å¤„ç†**       | `error.rs`                    | â­â­â­â­â­ | ç¨³å®šæ€§ä¿éšœ   |
| **çª—å£ç®¡ç†ä¸å¤šæ˜¾ç¤ºå™¨** | `window.rs`                   | â­â­â­â­â­ | ç”¨æˆ·ä½“éªŒ     |
| **WebDAV å®¢æˆ·ç«¯å®ç°**  | `backup.rs`                   | â­â­â­â­â­ | æ ¸å¿ƒåŒæ­¥åŠŸèƒ½ |
| **å¼‚æ­¥ä»»åŠ¡å¤„ç†**       | `backup.rs` (10è¡Œ)            | â­â­â­â­â­ | æ€§èƒ½å…³é”®     |

**ğŸŸ¡ P1 - æ¨èå­¦ä¹ ï¼ˆæå‡é¡¹ç›®è´¨é‡ï¼‰ï¼š**

| æŠ€æœ¯ç‚¹           | æ–‡ä»¶ä½ç½®                  | å­¦ä¹ ä»·å€¼   | åº”ç”¨åœºæ™¯     |
| ---------------- | ------------------------- | ---------- | ------------ |
| **ç³»ç»Ÿæ‰˜ç›˜é›†æˆ** | `tray.rs`                 | â­â­â­â­   | åå°è¿è¡Œ     |
| **å…¨å±€å¿«æ·é”®**   | `hotkey.rs`               | â­â­â­â­   | å¿«é€Ÿæ“ä½œ     |
| **HTTPæœåŠ¡å™¨**   | `server.rs`               | â­â­â­â­   | å¤–éƒ¨è°ƒç”¨æ¥å£ |
| **æ’ä»¶ç³»ç»Ÿ**     | `cmd.rs` (131-176è¡Œ)      | â­â­â­â­   | åŠŸèƒ½æ‰©å±•     |
| **å¹³å°ç‰¹å®šä»£ç ** | `system_ocr.rs`           | â­â­â­â­â­ | è·¨å¹³å°å…¼å®¹   |
| **é˜²æŠ–ä¼˜åŒ–**     | `useConfig.jsx` (13è¡Œ)    | â­â­â­â­â­ | æ€§èƒ½ä¼˜åŒ–     |
| **äº‹ä»¶ç³»ç»Ÿ**     | `useConfig.jsx` (49-56è¡Œ) | â­â­â­â­   | é…ç½®åŒæ­¥     |
| **ä»£ç†é…ç½®**     | `cmd.rs` (99-128è¡Œ)       | â­â­â­â­   | ç½‘ç»œé…ç½®     |

**âšª P2 - è¿›é˜¶å­¦ä¹ ï¼ˆæå‡ä»£ç è´¨é‡ï¼‰ï¼š**

| æŠ€æœ¯ç‚¹           | æ–‡ä»¶ä½ç½®                  | å­¦ä¹ ä»·å€¼   | åº”ç”¨åœºæ™¯     |
| ---------------- | ------------------------- | ---------- | ------------ |
| **å›¾ç‰‡å¤„ç†**     | `cmd.rs` (24-96è¡Œ)        | â­â­â­     | OCRåŠŸèƒ½      |
| **æ–‡ä»¶ç³»ç»Ÿç›‘å¬** | `store.js` (12-15è¡Œ)      | â­â­â­â­   | é…ç½®çƒ­é‡è½½   |
| **ç¼“å­˜ç®¡ç†**     | `screenshot.rs` (16-22è¡Œ) | â­â­â­     | ä¸´æ—¶æ–‡ä»¶ç®¡ç† |
| **æ¡ä»¶ç¼–è¯‘**     | `system_ocr.rs`           | â­â­â­â­â­ | å¹³å°å·®å¼‚åŒ–   |

---

## 14. æ’ä»¶ç³»ç»Ÿè®¾è®¡

### 14.1 æ’ä»¶æ¶æ„

**æ’ä»¶åŠ è½½æœºåˆ¶ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/cmd.rs` (131-176è¡Œ)

```rust
#[tauri::command]
pub fn install_plugin(path_list: Vec<String>) -> Result<i32, Error> {
    let mut success_count = 0;

    for path in path_list {
        // âœ… éªŒè¯æ–‡ä»¶æ‰©å±•å
        if !path.ends_with("potext") {
            continue;
        }

        // âœ… éªŒè¯æ’ä»¶åç§°æ ¼å¼
        let file_name = file_name.replace(".potext", "");
        if !file_name.starts_with("plugin") {
            return Err(Error::Error(
                "Invalid Plugin: file name must start with plugin".into(),
            ));
        }

        // âœ… éªŒè¯æ’ä»¶ç»“æ„ (info.json + main.js)
        let mut zip = zip::ZipArchive::new(std::fs::File::open(path)?)?;
        if let Ok(mut info) = zip.by_name("info.json") {
            let mut content = String::new();
            info.read_to_string(&mut content)?;
            let json: serde_json::Value = serde_json::from_str(&content)?;
            plugin_type = json["plugin_type"]
                .as_str()
                .ok_or(Error::Error("can't find plugin type in info.json".into()))?
                .to_string();
        } else {
            return Err(Error::Error("Invalid Plugin: miss info.json".into()));
        }

        if zip.by_name("main.js").is_err() {
            return Err(Error::Error("Invalid Plugin: miss main.js".into()));
        }

        // âœ… è§£å‹åˆ°æŒ‡å®šç›®å½•
        let config_path = config_dir().unwrap();
        let config_path = config_path.join(
            APP.get().unwrap().config().tauri.bundle.identifier.clone()
        );
        let config_path = config_path.join("plugins");
        let config_path = config_path.join(plugin_type);
        let plugin_path = config_path.join(file_name);

        std::fs::create_dir_all(&config_path)?;
        zip.extract(&plugin_path)?;

        success_count += 1;
    }
    Ok(success_count)
}
```

**æ’ä»¶ç³»ç»Ÿè®¾è®¡è¦ç‚¹è¡¨ï¼š**

| è®¾è®¡è¦ç‚¹     | å®ç°æ–¹å¼                          | ä»£ç ä½ç½®             | å­¦ä¹ ä»·å€¼          |
| ------------ | --------------------------------- | -------------------- | ----------------- |
| **æ’ä»¶éªŒè¯** | æ£€æŸ¥æ–‡ä»¶æ‰©å±•åå’Œåç§°æ ¼å¼          | `cmd.rs` (135-145è¡Œ) | â­â­â­â­â­ å®‰å…¨æ€§ |
| **ç»“æ„éªŒè¯** | æ£€æŸ¥å¿…éœ€æ–‡ä»¶ (info.json, main.js) | `cmd.rs` (150-163è¡Œ) | â­â­â­â­â­ å®Œæ•´æ€§ |
| **ç±»å‹åˆ†ç±»** | æŒ‰ plugin_type åˆ†ç±»å­˜å‚¨           | `cmd.rs` (154-158è¡Œ) | â­â­â­â­ ç»„ç»‡æ€§   |
| **ç›®å½•éš”ç¦»** | ä¸åŒæ’ä»¶ç±»å‹ç‹¬ç«‹ç›®å½•              | `cmd.rs` (164-169è¡Œ) | â­â­â­â­ æ¨¡å—åŒ–   |
| **æ‰¹é‡å®‰è£…** | æ”¯æŒä¸€æ¬¡å®‰è£…å¤šä¸ªæ’ä»¶              | `cmd.rs` (131è¡Œ)     | â­â­â­ æ•ˆç‡       |

### 14.2 æ’ä»¶å‘ç°æœºåˆ¶

**åŠ¨æ€åŠ è½½æ’ä»¶åˆ—è¡¨ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/config.rs` (140-166è¡Œ)

```rust
pub fn get_plugin_list(plugin_type: &str) -> Option<Vec<String>> {
    let app_handle = APP.get().unwrap();
    let config_dir = dirs::config_dir()?;
    let config_dir = config_dir.join(
        app_handle.config().tauri.bundle.identifier.clone()
    );
    let plugin_dir = config_dir.join("plugins");
    let plugin_dir = plugin_dir.join(plugin_type);

    // âœ… æ‰«ææ’ä»¶ç›®å½•
    let mut plugin_list = vec![];
    if plugin_dir.exists() {
        let read_dir = std::fs::read_dir(plugin_dir).ok()?;
        for entry in read_dir {
            let entry = entry.ok()?;

            if entry.path().is_dir() {
                let name = entry.file_name().to_str()?.to_string();
                if name.starts_with("plugin") {
                    plugin_list.push(name);
                } else {
                    // âœ… æ¸…ç†æ—§ç‰ˆæœ¬æ’ä»¶
                    let _ = std::fs::remove_dir_all(entry.path());
                }
            }
        }
    }
    Some(plugin_list)
}
```

**æ’ä»¶ç®¡ç†æœ€ä½³å®è·µï¼š**

| å®è·µ         | è¯´æ˜                   | ä»£ç ä½ç½®                | LightSync åº”ç”¨       |
| ------------ | ---------------------- | ----------------------- | -------------------- |
| **å‘½åè§„èŒƒ** | å¿…é¡»ä»¥ `plugin` å¼€å¤´   | `config.rs` (156è¡Œ)     | âœ… åŒæ­¥è§„åˆ™æ’ä»¶      |
| **è‡ªåŠ¨æ¸…ç†** | åˆ é™¤ä¸ç¬¦åˆè§„èŒƒçš„æ’ä»¶   | `config.rs` (159-161è¡Œ) | âœ… ç»´æŠ¤æ’ä»¶ç›®å½•      |
| **ç±»å‹éš”ç¦»** | æŒ‰åŠŸèƒ½ç±»å‹åˆ†ç±»         | `config.rs` (145è¡Œ)     | âœ… åŒæ­¥/å¤‡ä»½æ’ä»¶åˆ†ç¦» |
| **å¯é€‰åŠ è½½** | æ’ä»¶ä¸å­˜åœ¨æ—¶è¿”å›ç©ºåˆ—è¡¨ | `config.rs` (149è¡Œ)     | âœ… ä¼˜é›…é™çº§          |

### 14.3 æ’ä»¶æ‰§è¡Œæœºåˆ¶

**äºŒè¿›åˆ¶æ’ä»¶æ‰§è¡Œï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/cmd.rs` (179-210è¡Œ)

```rust
#[tauri::command]
pub fn run_binary(
    plugin_type: String,
    plugin_name: String,
    cmd_name: String,
    args: Vec<String>,
) -> Result<Value, Error> {
    #[cfg(target_os = "windows")]
    use std::os::windows::process::CommandExt;
    use std::process::Command;

    let config_path = dirs::config_dir().unwrap();
    let config_path = config_path.join(
        APP.get().unwrap().config().tauri.bundle.identifier.clone()
    );
    let config_path = config_path.join("plugins");
    let config_path = config_path.join(plugin_type);
    let plugin_path = config_path.join(plugin_name);

    // âœ… Windows å¹³å°ç‰¹æ®Šå¤„ç†
    #[cfg(target_os = "windows")]
    let mut cmd = Command::new("cmd");
    #[cfg(target_os = "windows")]
    let cmd = cmd.creation_flags(0x08000000);  // CREATE_NO_WINDOW
    #[cfg(target_os = "windows")]
    let cmd = cmd.args(["/c", &cmd_name]);

    // âœ… Unix å¹³å°ç›´æ¥æ‰§è¡Œ
    #[cfg(not(target_os = "windows"))]
    let mut cmd = Command::new(&cmd_name);

    // âœ… åœ¨æ’ä»¶ç›®å½•ä¸­æ‰§è¡Œï¼Œä¼ é€’å‚æ•°
    let output = cmd.args(args).current_dir(plugin_path).output()?;
    Ok(json!({
        "stdout": String::from_utf8_lossy(&output.stdout).to_string(),
        "stderr": String::from_utf8_lossy(&output.stderr).to_string(),
        "status": output.status.code().unwrap_or(-1),
    }))
}
```

**æ’ä»¶æ‰§è¡Œå®‰å…¨è¦ç‚¹ï¼š**

| å®‰å…¨æªæ–½         | å®ç°æ–¹å¼           | ä»£ç ä½ç½®             | é‡è¦æ€§             |
| ---------------- | ------------------ | -------------------- | ------------------ |
| **å·¥ä½œç›®å½•é™åˆ¶** | ä»…åœ¨æ’ä»¶ç›®å½•æ‰§è¡Œ   | `cmd.rs` (204è¡Œ)     | ğŸ”´ P0 é˜²æ­¢è·¯å¾„éå† |
| **æ— çª—å£æ‰§è¡Œ**   | Windows éšè—æ§åˆ¶å° | `cmd.rs` (198è¡Œ)     | ğŸŸ¡ P1 ç”¨æˆ·ä½“éªŒ     |
| **è¾“å‡ºæ•è·**     | æ•è· stdout/stderr | `cmd.rs` (205-208è¡Œ) | ğŸŸ¡ P1 é”™è¯¯å¤„ç†     |
| **çŠ¶æ€ç è¿”å›**   | è¿”å›æ‰§è¡ŒçŠ¶æ€       | `cmd.rs` (209è¡Œ)     | ğŸŸ¡ P1 ç»“æœåˆ¤æ–­     |

---

## 15. HTTP æœåŠ¡å™¨ä¸äº‹ä»¶ç³»ç»Ÿ

### 15.1 æœ¬åœ° HTTP æœåŠ¡å™¨

**è½»é‡çº§ HTTP æœåŠ¡å™¨å®ç°ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/server.rs` (8-32è¡Œ)

```rust
use tiny_http::{Request, Response, Server};

pub fn start_server() {
    let port = match get("server_port") {
        Some(v) => v.as_i64().unwrap(),
        None => {
            set("server_port", 60828);
            60828
        }
    };

    // âœ… åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­è¿è¡ŒæœåŠ¡å™¨
    thread::spawn(move || {
        let server = match Server::http(format!("127.0.0.1:{port}")) {
            Ok(v) => v,
            Err(e) => {
                // âœ… é”™è¯¯æ—¶é€šçŸ¥ç”¨æˆ·
                let _ = notification::Notification::new("com.pot-spp.com")
                    .title("Server start failed")
                    .body("Please Change Server Port and restart the application")
                    .show();
                warn!("Server start failed: {}", e);
                return;
            }
        };

        // âœ… é˜»å¡å¼å¤„ç†è¯·æ±‚
        for request in server.incoming_requests() {
            http_handle(request);
        }
    });
}
```

**HTTP æœåŠ¡å™¨è®¾è®¡è¦ç‚¹ï¼š**

| ç‰¹æ€§         | å®ç°æ–¹å¼           | ä»£ç ä½ç½®              | LightSync åº”ç”¨  |
| ------------ | ------------------ | --------------------- | --------------- |
| **ç«¯å£é…ç½®** | å¯é…ç½®ï¼Œé»˜è®¤ 60828 | `server.rs` (9-15è¡Œ)  | âœ… åŒæ­¥æœåŠ¡ç«¯å£ |
| **é”™è¯¯å¤„ç†** | å¯åŠ¨å¤±è´¥æ—¶é€šçŸ¥ç”¨æˆ· | `server.rs` (19-25è¡Œ) | âœ… å‹å¥½é”™è¯¯æç¤º |
| **ç‹¬ç«‹çº¿ç¨‹** | ä¸é˜»å¡ä¸»çº¿ç¨‹       | `server.rs` (16è¡Œ)    | âœ… åå°æœåŠ¡     |
| **æœ¬åœ°ç»‘å®š** | ä»…ç›‘å¬ 127.0.0.1   | `server.rs` (17è¡Œ)    | âœ… å®‰å…¨æ€§       |

### 15.2 è·¯ç”±å¤„ç†æœºåˆ¶

**è¯·æ±‚è·¯ç”±åˆ†å‘ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/server.rs` (34-50è¡Œ)

```rust
fn http_handle(request: Request) {
    info!("Handle {} request", request.url());
    match request.url() {
        "/" => handle_translate(request),
        "/config" => handle_config(request),
        "/translate" => handle_translate(request),
        "/selection_translate" => handle_selection_translate(request),
        "/input_translate" => handle_input_translate(request),
        "/ocr_recognize" => handle_ocr_recognize(request),
        "/ocr_translate" => handle_ocr_translate(request),
        "/ocr_recognize?screenshot=false" => handle_ocr_recognize(request),
        "/ocr_translate?screenshot=false" => handle_ocr_translate(request),
        "/ocr_recognize?screenshot=true" => handle_ocr_recognize(request),
        "/ocr_translate?screenshot=true" => handle_ocr_translate(request),
        _ => warn!("Unknown request url: {}", request.url()),
    }
}
```

**è·¯ç”±è®¾è®¡æ¨¡å¼ï¼š**

| æ¨¡å¼         | å®ç°æ–¹å¼              | ä¼˜åŠ¿     | LightSync åº”ç”¨                  |
| ------------ | --------------------- | -------- | ------------------------------- |
| **è·¯å¾„åŒ¹é…** | `match request.url()` | ç®€å•ç›´æ¥ | âœ… `/sync`, `/pause`, `/status` |
| **å‚æ•°è§£æ** | URL æŸ¥è¯¢å‚æ•°          | çµæ´»é…ç½® | âœ… `/sync?folder=1&force=true`  |
| **ç»Ÿä¸€å“åº”** | `response_ok()` å‡½æ•°  | ç®€åŒ–ä»£ç  | âœ… ç»Ÿä¸€è¿”å› JSON                |
| **é”™è¯¯æ—¥å¿—** | `warn!` è®°å½•æœªçŸ¥è¯·æ±‚  | ä¾¿äºè°ƒè¯• | âœ… è®°å½•æ— æ•ˆè¯·æ±‚                 |

**LightSync HTTP API å»ºè®®ï¼š**

```rust
// å»ºè®®çš„åŒæ­¥ API è·¯ç”±
match request.url() {
    "/sync" => handle_sync(request),                    // è§¦å‘åŒæ­¥
    "/sync/status" => handle_sync_status(request),      // æŸ¥è¯¢çŠ¶æ€
    "/sync/pause" => handle_pause_sync(request),        // æš‚åœåŒæ­¥
    "/sync/resume" => handle_resume_sync(request),      // æ¢å¤åŒæ­¥
    "/sync/progress" => handle_sync_progress(request),  // æŸ¥è¯¢è¿›åº¦
    "/config/reload" => handle_reload_config(request),  // é‡è½½é…ç½®
    _ => warn!("Unknown request url: {}", request.url()),
}

fn handle_sync(mut request: Request) {
    // è§£æè¯·æ±‚å‚æ•°
    let mut content = String::new();
    request.as_reader().read_to_string(&mut content).unwrap();
    let params: serde_json::Value = serde_json::from_str(&content).unwrap();

    // è§¦å‘åŒæ­¥
    let folder_id = params["folder_id"].as_str();
    let force = params["force"].as_bool().unwrap_or(false);

    // è¿”å› JSON å“åº”
    let response = Response::from_string(
        serde_json::to_string(&json!({
            "success": true,
            "message": "Sync started"
        })).unwrap()
    ).with_header(
        tiny_http::Header::from_bytes(
            &b"Content-Type"[..],
            &b"application/json"[..]
        ).unwrap()
    );
    request.respond(response).unwrap();
}
```

### 15.3 äº‹ä»¶é©±åŠ¨æ¶æ„

**å‰ç«¯äº‹ä»¶ç›‘å¬ï¼š**

æ–‡ä»¶ï¼š`src/hooks/useConfig.jsx` (45-57è¡Œ)

```javascript
// åˆå§‹åŒ–
useEffect(() => {
  syncToState(null)
  const eventKey = key.replaceAll('.', '_').replaceAll('@', ':')

  // âœ… ç›‘å¬é…ç½®å˜æ›´äº‹ä»¶
  const unlisten = listen(`${eventKey}_changed`, e => {
    syncToState(e.payload)
  })

  // âœ… æ¸…ç†å‡½æ•°ï¼šå–æ¶ˆç›‘å¬
  return () => {
    unlisten.then(f => {
      f()
    })
  }
}, [])
```

**äº‹ä»¶å‘½åè§„èŒƒï¼š**

| äº‹ä»¶ç±»å‹     | å‘½åè§„åˆ™            | ç¤ºä¾‹                    | ç”¨é€”         |
| ------------ | ------------------- | ----------------------- | ------------ |
| **é…ç½®å˜æ›´** | `{key}_changed`     | `sync_interval_changed` | é…ç½®æ›´æ–°é€šçŸ¥ |
| **çŠ¶æ€å˜æ›´** | `{entity}_status`   | `sync_status`           | çŠ¶æ€åŒæ­¥     |
| **é”™è¯¯äº‹ä»¶** | `{action}_error`    | `sync_error`            | é”™è¯¯é€šçŸ¥     |
| **å®Œæˆäº‹ä»¶** | `{action}_complete` | `sync_complete`         | æ“ä½œå®Œæˆ     |

**äº‹ä»¶ç³»ç»Ÿä¼˜åŠ¿è¡¨ï¼š**

| ä¼˜åŠ¿       | è¯´æ˜               | ä»£ç ä½ç½®                  | LightSync åº”ç”¨          |
| ---------- | ------------------ | ------------------------- | ----------------------- |
| **è§£è€¦**   | å‘å¸ƒè€…ä¸è®¢é˜…è€…åˆ†ç¦» | `useConfig.jsx` (49-51è¡Œ) | âœ… é…ç½®ä¸UIè§£è€¦         |
| **å®æ—¶æ€§** | é…ç½®å˜æ›´ç«‹å³ç”Ÿæ•ˆ   | `useConfig.jsx` (13-20è¡Œ) | âœ… åŒæ­¥çŠ¶æ€å®æ—¶æ›´æ–°     |
| **è·¨çª—å£** | å¤šçª—å£é…ç½®åŒæ­¥     | `store.js` (12-15è¡Œ)      | âœ… ä¸»çª—å£ä¸è®¾ç½®çª—å£åŒæ­¥ |
| **å¯æ‰©å±•** | æ˜“äºæ·»åŠ æ–°äº‹ä»¶     | äº‹ä»¶å‘½åè§„èŒƒ              | âœ… æ–°å¢åŒæ­¥äº‹ä»¶         |

---

## 16. æ€§èƒ½ä¼˜åŒ–æŠ€å·§

### 16.1 é˜²æŠ–ä¸èŠ‚æµ

**é˜²æŠ–å‡½æ•°å®ç°ï¼š**

æ–‡ä»¶ï¼š`src/utils/index.js` (1-7è¡Œ)

```javascript
export const debounce = (fn, delay = 500) => {
  let timer = null
  return (...args) => {
    timer && clearTimeout(timer) // âœ… å–æ¶ˆä¹‹å‰çš„å®šæ—¶å™¨
    timer = setTimeout(() => fn(...args), delay) // âœ… é‡æ–°è®¾ç½®å®šæ—¶å™¨
  }
}
```

**é˜²æŠ–åº”ç”¨åœºæ™¯ï¼š**

æ–‡ä»¶ï¼š`src/hooks/useConfig.jsx` (12-20è¡Œ)

```javascript
// åŒæ­¥åˆ°Store (State -> Store)
const syncToStore = useCallback(
  debounce(v => {
    store.set(key, v)
    store.save()
    let eventKey = key.replaceAll('.', '_').replaceAll('@', ':')
    emit(`${eventKey}_changed`, v)
  }),
  []
)
```

**é˜²æŠ–ä¸èŠ‚æµå¯¹æ¯”è¡¨ï¼š**

| ä¼˜åŒ–æŠ€æœ¯            | é€‚ç”¨åœºæ™¯           | å®ç°æ–¹å¼             | æ•ˆæœ         | ä»£ç ä½ç½®               |
| ------------------- | ------------------ | -------------------- | ------------ | ---------------------- |
| **é˜²æŠ– (Debounce)** | é…ç½®ä¿å­˜ã€æœç´¢è¾“å…¥ | å»¶è¿Ÿæ‰§è¡Œï¼Œå–æ¶ˆå‰ä¸€æ¬¡ | å‡å°‘å†™å…¥æ¬¡æ•° | `useConfig.jsx` (13è¡Œ) |
| **èŠ‚æµ (Throttle)** | æ»šåŠ¨äº‹ä»¶ã€é¼ æ ‡ç§»åŠ¨ | å›ºå®šé—´éš”æ‰§è¡Œ         | é™åˆ¶æ‰§è¡Œé¢‘ç‡ | å»ºè®®å®ç°               |
| **æ‰¹é‡å¤„ç†**        | æ–‡ä»¶å˜æ›´äº‹ä»¶       | åˆå¹¶çŸ­æ—¶é—´å†…çš„æ“ä½œ   | å‡å°‘åŒæ­¥æ¬¡æ•° | å»ºè®®å®ç°               |

**LightSync åŒæ­¥é˜²æŠ–å»ºè®®ï¼š**

```javascript
// å»ºè®®ï¼šæ–‡ä»¶å˜æ›´äº‹ä»¶é˜²æŠ–
import { debounce } from '../utils'

const debouncedSync = debounce(folderId => {
  invoke('trigger_sync', { folderId })
}, 2000) // 2ç§’å†…å¤šæ¬¡å˜æ›´åªè§¦å‘ä¸€æ¬¡åŒæ­¥

// ä½¿ç”¨
useEffect(() => {
  const unlisten = listen('file_changed', event => {
    debouncedSync(event.payload.folderId)
  })
  return () => unlisten.then(f => f())
}, [])
```

### 16.2 å†…å­˜ä¼˜åŒ–

**å‰ªè´´æ¿ç›‘æ§ä¼˜åŒ–ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/clipboard.rs` (7-33è¡Œ)

```rust
pub fn start_clipboard_monitor(app_handle: tauri::AppHandle) {
    tauri::async_runtime::spawn(async move {
        let mut pre_text = "".to_string();  // âœ… ç¼“å­˜ä¸Šä¸€æ¬¡å†…å®¹

        loop {
            let handle = app_handle.app_handle();
            let state = handle.state::<ClipboardMonitorEnableWrapper>();

            // âœ… ä½¿ç”¨ try_lock é¿å…é˜»å¡
            if let Ok(clipboard_monitor) = state.0.try_lock() {
                if clipboard_monitor.contains("true") {
                    if let Ok(result) = app_handle.clipboard_manager().read_text() {
                        match result {
                            Some(v) => {
                                // âœ… é¿å…é‡å¤å¤„ç†ç›¸åŒå†…å®¹
                                if v != pre_text {
                                    text_translate(v.clone());
                                    pre_text = v;
                                }
                            }
                            None => {}
                        }
                    }
                } else {
                    break;  // âœ… åŠæ—¶é€€å‡ºï¼Œé‡Šæ”¾èµ„æº
                }
            }
            std::thread::sleep(std::time::Duration::from_millis(500));  // âœ… è½®è¯¢é—´éš”
        }
    });
}
```

**å†…å­˜ä¼˜åŒ–æŠ€å·§è¡¨ï¼š**

| ä¼˜åŒ–æŠ€å·§     | å®ç°æ–¹å¼                   | ä»£ç ä½ç½®                 | æ•ˆæœ          |
| ------------ | -------------------------- | ------------------------ | ------------- |
| **å†…å®¹ç¼“å­˜** | `pre_text` é¿å…é‡å¤å¤„ç†    | `clipboard.rs` (9è¡Œ)     | å‡å°‘ CPU ä½¿ç”¨ |
| **éé˜»å¡é”** | `try_lock()` é¿å…æ­»é”      | `clipboard.rs` (13è¡Œ)    | æé«˜å“åº”æ€§    |
| **åŠæ—¶é€€å‡º** | æ¡ä»¶æ»¡è¶³æ—¶é€€å‡ºå¾ªç¯         | `clipboard.rs` (26-28è¡Œ) | é‡Šæ”¾èµ„æº      |
| **åˆç†è½®è¯¢** | 500ms é—´éš”å¹³è¡¡å®æ—¶æ€§å’Œæ€§èƒ½ | `clipboard.rs` (30è¡Œ)    | ä¼˜åŒ–èµ„æºæ¶ˆè€—  |

### 16.3 å»¶è¿Ÿåˆå§‹åŒ–

**è¯­è¨€æ£€æµ‹é¢„çƒ­ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/main.rs` (112-116è¡Œ)

```rust
// âœ… æ ¹æ®é…ç½®å†³å®šæ˜¯å¦åˆå§‹åŒ–
if let Some(engine) = get("translate_detect_engine") {
    if engine.as_str().unwrap() == "local" {
        init_lang_detect();  // ä»…åœ¨éœ€è¦æ—¶åˆå§‹åŒ–
    }
}
```

**å»¶è¿Ÿåˆå§‹åŒ–ç­–ç•¥è¡¨ï¼š**

| ç­–ç•¥           | å®ç°æ–¹å¼               | é€‚ç”¨åœºæ™¯          | æ•ˆæœ         |
| -------------- | ---------------------- | ----------------- | ------------ |
| **æ¡ä»¶åˆå§‹åŒ–** | æ ¹æ®é…ç½®å†³å®šæ˜¯å¦åˆå§‹åŒ– | è¯­è¨€æ£€æµ‹ã€OCRå¼•æ“ | å‡å°‘å¯åŠ¨æ—¶é—´ |
| **å¼‚æ­¥åˆå§‹åŒ–** | åå°çº¿ç¨‹åˆå§‹åŒ–         | å¤§å‹èµ„æºåŠ è½½      | ä¸é˜»å¡ UI    |
| **æ‡’åŠ è½½**     | é¦–æ¬¡ä½¿ç”¨æ—¶åˆå§‹åŒ–       | æ’ä»¶ç³»ç»Ÿ          | æŒ‰éœ€åŠ è½½     |

---

## 17. å¹³å°ç‰¹å®šä»£ç å¤„ç†

### 17.1 æ¡ä»¶ç¼–è¯‘

**Windows å¹³å°ç‰¹å®šä»£ç ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/system_ocr.rs` (4-61è¡Œ)

```rust
#[tauri::command(async)]
#[cfg(target_os = "windows")]
pub fn system_ocr(app_handle: tauri::AppHandle, lang: &str) -> Result<String, String> {
    use windows::core::HSTRING;
    use windows::Globalization::Language;
    use windows::Graphics::Imaging::BitmapDecoder;
    use windows::Media::Ocr::OcrEngine;
    use windows::Storage::{FileAccessMode, StorageFile};

    // âœ… Windows ç‰¹æœ‰ API è°ƒç”¨
    let file = StorageFile::GetFileFromPathAsync(&HSTRING::from(path))
        .unwrap()
        .get()
        .unwrap();

    // ...
}
```

**macOS å¹³å°ç‰¹å®šä»£ç ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/system_ocr.rs` (64-104è¡Œ)

```rust
#[tauri::command(async)]
#[cfg(target_os = "macos")]
pub fn system_ocr(app_handle: tauri::AppHandle, lang: &str) -> Result<String, String> {
    // âœ… macOS ä½¿ç”¨èµ„æºæ–‡ä»¶ä¸­çš„äºŒè¿›åˆ¶
    let arch = std::env::consts::ARCH;
    let bin_path = match app_handle
        .path_resolver()
        .resolve_resource(format!("resources/ocr-{arch}-apple-darwin"))
    {
        Some(v) => v,
        None => return Err("Failed to resolve ocr binary".to_string()),
    };

    // âœ… è®¾ç½®æ‰§è¡Œæƒé™
    match std::process::Command::new("chmod")
        .arg("+x")
        .arg(bin_path.to_str().unwrap())
        .output()
    {
        Ok(_) => {}
        Err(e) => return Err(e.to_string()),
    }

    // ...
}
```

**Linux å¹³å°ç‰¹å®šä»£ç ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/system_ocr.rs` (107-151è¡Œ)

```rust
#[tauri::command(async)]
#[cfg(target_os = "linux")]
pub fn system_ocr(app_handle: tauri::AppHandle, lang: &str) -> Result<String, String> {
    // âœ… Linux ä½¿ç”¨ç³»ç»Ÿå®‰è£…çš„ tesseract
    let output = match std::process::Command::new("tesseract")
        .arg(app_cache_dir_path.to_str().unwrap())
        .arg("stdout")
        .args(args)
        .output()
    {
        Ok(v) => v,
        Err(e) => {
            // âœ… å‹å¥½çš„é”™è¯¯æç¤º
            if e.to_string().contains("os error 2") {
                return Err("Tesseract not installed!".to_string());
            }
            return Err(e.to_string());
        }
    };

    // âœ… æ£€æŸ¥è¯­è¨€åŒ…æ˜¯å¦å®‰è£…
    if content.contains("data") {
        if lang == "auto" {
            return Err(
                "Language data not installed!\nPlease try install tesseract-ocr-eng"
                    .to_string(),
            );
        } else {
            return Err(format!(
                "Language data not installed!\nPlease try install tesseract-ocr-{lang}"
            ));
        }
    }
    // ...
}
```

**æ¡ä»¶ç¼–è¯‘æœ€ä½³å®è·µè¡¨ï¼š**

| å®è·µ         | å®ç°æ–¹å¼                        | ä»£ç ä½ç½®                  | å­¦ä¹ ä»·å€¼              |
| ------------ | ------------------------------- | ------------------------- | --------------------- |
| **å¹³å°å®**   | `#[cfg(target_os = "windows")]` | `system_ocr.rs` (4è¡Œ)     | â­â­â­â­â­ ç¼–è¯‘æ—¶æ¡ä»¶ |
| **ç‰¹æ€§æ£€æµ‹** | `#[cfg(feature = "...")]`       | Cargo.toml                | â­â­â­â­ å¯é€‰åŠŸèƒ½     |
| **æ¶æ„æ£€æµ‹** | `std::env::consts::ARCH`        | `system_ocr.rs` (70è¡Œ)    | â­â­â­â­ æ¶æ„åŒºåˆ†     |
| **å‹å¥½é”™è¯¯** | å¹³å°ç‰¹å®šçš„é”™è¯¯æ¶ˆæ¯              | `system_ocr.rs` (54-58è¡Œ) | â­â­â­â­ ç”¨æˆ·ä½“éªŒ     |

**LightSync å¹³å°ç‰¹å®šéœ€æ±‚ï¼š**

```rust
// å»ºè®®ï¼šæ–‡ä»¶ç›‘æ§å¹³å°ç‰¹å®šå®ç°
#[cfg(target_os = "windows")]
use notify::RecommendedWatcher;
#[cfg(target_os = "macos")]
use notify::PollWatcher;  // macOS æ–‡ä»¶ç³»ç»Ÿäº‹ä»¶å¯èƒ½ä¸ç¨³å®š
#[cfg(target_os = "linux")]
use notify::PollWatcher;  // Linux æŸäº›æ–‡ä»¶ç³»ç»Ÿéœ€è¦è½®è¯¢

#[cfg(target_os = "windows")]
pub fn watch_folder(path: &Path) -> Result<RecommendedWatcher> {
    // Windows ä½¿ç”¨ FSEvents
}

#[cfg(target_os = "macos")]
pub fn watch_folder(path: &Path) -> Result<PollWatcher> {
    // macOS ä½¿ç”¨è½®è¯¢ï¼ˆæ›´å¯é ï¼‰
}

#[cfg(target_os = "linux")]
pub fn watch_folder(path: &Path) -> Result<PollWatcher> {
    // Linux ä½¿ç”¨ inotify æˆ–è½®è¯¢
}
```

### 17.2 çª—å£å¹³å°å·®å¼‚

**macOS çª—å£æ ·å¼ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/window.rs` (94-99è¡Œ)

```rust
#[cfg(target_os = "macos")]
{
    builder = builder
        .title_bar_style(tauri::TitleBarStyle::Overlay)  // âœ… é€æ˜æ ‡é¢˜æ 
        .hidden_title(true);  // âœ… éšè—æ ‡é¢˜
}
```

**Windows/Linux çª—å£æ ·å¼ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/window.rs` (100-103è¡Œ)

```rust
#[cfg(not(target_os = "macos"))]
{
    builder = builder
        .transparent(true)      // âœ… é€æ˜çª—å£
        .decorations(false);     // âœ… æ— è¾¹æ¡†
}
```

**å¹³å°çª—å£å·®å¼‚å¤„ç†è¡¨ï¼š**

| å¹³å°         | çª—å£æ ·å¼         | ä»£ç ä½ç½®                | LightSync åº”ç”¨         |
| ------------ | ---------------- | ----------------------- | ---------------------- |
| **macOS**    | Overlay æ ‡é¢˜æ    | `window.rs` (96-98è¡Œ)   | âœ… é€‚é… macOS è®¾è®¡è§„èŒƒ |
| **Windows**  | é€æ˜æ— è¾¹æ¡†       | `window.rs` (102è¡Œ)     | âœ… ç°ä»£åŒ– UI           |
| **Linux**    | é€æ˜æ— è¾¹æ¡†       | `window.rs` (102è¡Œ)     | âœ… ç»Ÿä¸€ä½“éªŒ            |
| **é˜´å½±æ•ˆæœ** | ä»… macOS/Windows | `window.rs` (107-108è¡Œ) | âœ… è§†è§‰å±‚æ¬¡            |

---

## 18. å›¾ç‰‡å¤„ç†ä¸ç¼“å­˜ç®¡ç†

### 18.1 æˆªå›¾å¤„ç†

**å±å¹•æˆªå›¾å®ç°ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/screenshot.rs` (4-30è¡Œ)

```rust
#[tauri::command]
pub fn screenshot(x: i32, y: i32) {
    use screenshots::{Compression, Screen};

    info!("Screenshot screen with position: x={}, y={}", x, y);

    // âœ… éå†æ‰€æœ‰æ˜¾ç¤ºå™¨
    let screens = Screen::all().unwrap();
    for screen in screens {
        let info = screen.display_info;
        info!("Screen: {:?}", info);

        // âœ… åŒ¹é…æŒ‡å®šä½ç½®çš„æ˜¾ç¤ºå™¨
        if info.x == x && info.y == y {
            let handle = APP.get().unwrap();
            let mut app_cache_dir_path = cache_dir().expect("Get Cache Dir Failed");
            app_cache_dir_path.push(&handle.config().tauri.bundle.identifier);

            // âœ… ç¡®ä¿ç¼“å­˜ç›®å½•å­˜åœ¨
            if !app_cache_dir_path.exists() {
                fs::create_dir_all(&app_cache_dir_path).expect("Create Cache Dir Failed");
            }

            app_cache_dir_path.push("pot_screenshot.png");

            // âœ… å¿«é€Ÿå‹ç¼©
            let image = screen.capture().unwrap();
            let buffer = image.to_png(Compression::Fast).unwrap();
            fs::write(app_cache_dir_path, buffer).unwrap();

            break;
        }
    }
}
```

**å›¾ç‰‡å¤„ç†ä¼˜åŒ–è¡¨ï¼š**

| ä¼˜åŒ–ç‚¹       | å®ç°æ–¹å¼            | ä»£ç ä½ç½®                  | æ•ˆæœ         |
| ------------ | ------------------- | ------------------------- | ------------ |
| **å¿«é€Ÿå‹ç¼©** | `Compression::Fast` | `screenshot.rs` (25è¡Œ)    | å‡å°‘å¤„ç†æ—¶é—´ |
| **ç¼“å­˜ç›®å½•** | ä½¿ç”¨ç³»ç»Ÿç¼“å­˜ç›®å½•    | `screenshot.rs` (16è¡Œ)    | è‡ªåŠ¨æ¸…ç†     |
| **å¤šæ˜¾ç¤ºå™¨** | éå†æ‰€æœ‰æ˜¾ç¤ºå™¨åŒ¹é…  | `screenshot.rs` (11-28è¡Œ) | æ”¯æŒå¤šå±     |
| **é”™è¯¯å¤„ç†** | `unwrap()` å¿«é€Ÿå¤±è´¥ | `screenshot.rs`           | ç®€åŒ–ä»£ç      |

### 18.2 å›¾ç‰‡è£å‰ª

**å›¾ç‰‡è£å‰ªå®ç°ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/cmd.rs` (24-50è¡Œ)

```rust
#[tauri::command]
pub fn cut_image(left: u32, top: u32, width: u32, height: u32, app_handle: tauri::AppHandle) {
    use image::GenericImage;

    info!("Cut image: {}x{}+{}+{}", width, height, left, top);

    let mut app_cache_dir_path = cache_dir().expect("Get Cache Dir Failed");
    app_cache_dir_path.push(&app_handle.config().tauri.bundle.identifier);
    app_cache_dir_path.push("pot_screenshot.png");

    // âœ… æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if !app_cache_dir_path.exists() {
        return;
    }

    // âœ… æ‰“å¼€å›¾ç‰‡
    let mut img = match image::open(&app_cache_dir_path) {
        Ok(v) => v,
        Err(e) => {
            error!("{:?}", e.to_string());
            return;
        }
    };

    // âœ… è£å‰ªå›¾ç‰‡
    let img2 = img.sub_image(left, top, width, height);

    // âœ… ä¿å­˜è£å‰ªåçš„å›¾ç‰‡
    app_cache_dir_path.pop();
    app_cache_dir_path.push("pot_screenshot_cut.png");
    match img2.to_image().save(&app_cache_dir_path) {
        Ok(_) => {}
        Err(e) => {
            error!("{:?}", e.to_string());
        }
    }
}
```

### 18.3 Base64 ç¼–ç 

**å›¾ç‰‡è½¬ Base64ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/cmd.rs` (53-75è¡Œ)

```rust
#[tauri::command]
pub fn get_base64(app_handle: tauri::AppHandle) -> String {
    use base64::{engine::general_purpose, Engine as _};

    let mut app_cache_dir_path = cache_dir().expect("Get Cache Dir Failed");
    app_cache_dir_path.push(&app_handle.config().tauri.bundle.identifier);
    app_cache_dir_path.push("pot_screenshot_cut.png");

    // âœ… æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if !app_cache_dir_path.exists() {
        return "".to_string();
    }

    // âœ… è¯»å–æ–‡ä»¶å†…å®¹
    let mut file = File::open(app_cache_dir_path).unwrap();
    let mut vec = Vec::new();
    match file.read_to_end(&mut vec) {
        Ok(_) => {}
        Err(e) => {
            error!("{:?}", e.to_string());
            return "".to_string();
        }
    }

    // âœ… Base64 ç¼–ç å¹¶å»é™¤æ¢è¡Œç¬¦
    let base64 = general_purpose::STANDARD.encode(&vec);
    base64.replace("\r\n", "")
}
```

**ç¼“å­˜ç®¡ç†æœ€ä½³å®è·µï¼š**

| å®è·µ             | å®ç°æ–¹å¼               | ä»£ç ä½ç½®        | LightSync åº”ç”¨  |
| ---------------- | ---------------------- | --------------- | --------------- |
| **ç³»ç»Ÿç¼“å­˜ç›®å½•** | `cache_dir()`          | `cmd.rs` (28è¡Œ) | âœ… åŒæ­¥ä¸´æ—¶æ–‡ä»¶ |
| **åº”ç”¨éš”ç¦»**     | ä½¿ç”¨ bundle identifier | `cmd.rs` (29è¡Œ) | âœ… é¿å…å†²çª     |
| **æ–‡ä»¶æ£€æŸ¥**     | æ“ä½œå‰æ£€æŸ¥å­˜åœ¨æ€§       | `cmd.rs` (31è¡Œ) | âœ… é˜²æ­¢é”™è¯¯     |
| **æ¸…ç†ç­–ç•¥**     | ä¸´æ—¶æ–‡ä»¶ç”¨å®Œå³åˆ        | å»ºè®®å®ç°        | âœ… èŠ‚çœç©ºé—´     |

---

## 19. ä»£ç†é…ç½®ç®¡ç†

### 19.1 ä»£ç†è®¾ç½®

**ç¯å¢ƒå˜é‡ä»£ç†é…ç½®ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/cmd.rs` (99-128è¡Œ)

```rust
#[tauri::command]
pub fn set_proxy() -> Result<bool, ()> {
    let host = match get("proxy_host") {
        Some(v) => v.as_str().unwrap().to_string(),
        None => return Err(()),
    };
    let port = match get("proxy_port") {
        Some(v) => v.as_i64().unwrap(),
        None => return Err(()),
    };
    let no_proxy = match get("no_proxy") {
        Some(v) => v.as_str().unwrap().to_string(),
        None => return Err(()),
    };
    let proxy = format!("http://{}:{}", host, port);

    // âœ… è®¾ç½®ç³»ç»Ÿç¯å¢ƒå˜é‡
    std::env::set_var("http_proxy", &proxy);
    std::env::set_var("https_proxy", &proxy);
    std::env::set_var("all_proxy", &proxy);
    std::env::set_var("no_proxy", &no_proxy);
    Ok(true)
}

#[tauri::command]
pub fn unset_proxy() -> Result<bool, ()> {
    // âœ… ç§»é™¤ç¯å¢ƒå˜é‡
    std::env::remove_var("http_proxy");
    std::env::remove_var("https_proxy");
    std::env::remove_var("all_proxy");
    std::env::remove_var("no_proxy");
    Ok(true)
}
```

**ä»£ç†é…ç½®åˆå§‹åŒ–ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/main.rs` (102-109è¡Œ)

```rust
match get("proxy_enable") {
    Some(v) => {
        if v.as_bool().unwrap()
            && get("proxy_host").map_or(false, |host| !host.as_str().unwrap().is_empty())
        {
            let _ = set_proxy();
        }
    }
    None => {}
}
```

**ä»£ç†é…ç½®ç®¡ç†è¡¨ï¼š**

| åŠŸèƒ½           | å®ç°æ–¹å¼       | ä»£ç ä½ç½®              | LightSync åº”ç”¨      |
| -------------- | -------------- | --------------------- | ------------------- |
| **åŠ¨æ€è®¾ç½®**   | ç¯å¢ƒå˜é‡æ–¹å¼   | `cmd.rs` (114-117è¡Œ)  | âœ… WebDAV è¯·æ±‚ä»£ç†  |
| **å¯åŠ¨æ—¶åŠ è½½** | è¯»å–é…ç½®å¹¶åº”ç”¨ | `main.rs` (102-109è¡Œ) | âœ… è‡ªåŠ¨åº”ç”¨ä»£ç†è®¾ç½® |
| **æ¡ä»¶å¯ç”¨**   | æ£€æŸ¥é…ç½®å¼€å…³   | `main.rs` (104è¡Œ)     | âœ… ç”¨æˆ·æ§åˆ¶         |
| **æ¸…ç†ä»£ç†**   | ç§»é™¤ç¯å¢ƒå˜é‡   | `cmd.rs` (123-126è¡Œ)  | âœ… ç¦ç”¨ä»£ç†         |

**LightSync ä»£ç†åº”ç”¨å»ºè®®ï¼š**

```rust
// å»ºè®®ï¼šWebDAV å®¢æˆ·ç«¯ä½¿ç”¨ä»£ç†
use reqwest::Proxy;

pub fn build_webdav_client(config: &ServerConfig) -> Result<Client> {
    let mut client_builder = ClientBuilder::new();

    // âœ… åº”ç”¨ä»£ç†é…ç½®
    if let Some(proxy_config) = get_proxy_config() {
        if proxy_config.enabled {
            let proxy = Proxy::http(&format!("http://{}:{}",
                proxy_config.host, proxy_config.port))?;
            client_builder = client_builder.proxy(proxy);
        }
    }

    Ok(client_builder.build()?)
}
```

---

## 20. é”™è¯¯å¤„ç†ä¸æ—¥å¿—ç³»ç»Ÿ

### 20.1 æ—¥å¿—é…ç½®

**æ—¥å¿—åˆå§‹åŒ–ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/main.rs` (55-58è¡Œ)

```rust
.plugin(
    tauri_plugin_log::Builder::default()
        .targets([LogTarget::LogDir, LogTarget::Stdout])  // âœ… åŒæ—¶è¾“å‡ºåˆ°æ–‡ä»¶å’Œæ§åˆ¶å°
        .build(),
)
```

**æ—¥å¿—çº§åˆ«ä¸ç›®æ ‡ï¼š**

| æ—¥å¿—ç›®æ ‡   | ç”¨é€”       | ä¼˜åŠ¿           | é€‚ç”¨åœºæ™¯ |
| ---------- | ---------- | -------------- | -------- |
| **LogDir** | æ–‡ä»¶æ—¥å¿—   | æŒä¹…åŒ–ã€å¯è¿½æº¯ | ç”Ÿäº§ç¯å¢ƒ |
| **Stdout** | æ§åˆ¶å°è¾“å‡º | å®æ—¶æŸ¥çœ‹       | å¼€å‘è°ƒè¯• |
| **Stderr** | é”™è¯¯è¾“å‡º   | åˆ†ç¦»é”™è¯¯æ—¥å¿—   | é”™è¯¯è¿½è¸ª |

### 20.2 é”™è¯¯å¤„ç†æ¨¡å¼

**ç»Ÿä¸€é”™è¯¯ç±»å‹ï¼š**

æ–‡ä»¶ï¼š`src-tauri/src/error.rs` (2-30è¡Œ)

```rust
#[derive(Debug, thiserror::Error)]
pub enum Error {
    #[error(transparent)]
    Io(#[from] std::io::Error),
    #[error(transparent)]
    Error(#[from] Box<dyn std::error::Error>),
    #[error(transparent)]
    Dav(#[from] reqwest_dav::Error),
    #[error(transparent)]
    DavRe(#[from] reqwest_dav::re_exports::reqwest::Error),
    #[error(transparent)]
    Serde(#[from] serde_json::Error),
    #[error(transparent)]
    Zip(#[from] zip::result::ZipError),
    #[error(transparent)]
    WalkDir(#[from] walkdir::Error),
    #[error(transparent)]
    Tauri(#[from] tauri::Error),
    #[error(transparent)]
    StripPrefix(#[from] std::path::StripPrefixError),
    #[error(transparent)]
    Arboard(#[from] arboard::Error),
    #[error(transparent)]
    Image(#[from] image::ImageError),
    #[error(transparent)]
    Selection(#[from] font_kit::error::SelectionError),
    #[error(transparent)]
    Reqwest(#[from] reqwest::Error),
}
```

**é”™è¯¯å¤„ç†æœ€ä½³å®è·µï¼š**

| å®è·µ           | å®ç°æ–¹å¼                | ä¼˜åŠ¿             | ä»£ç ä½ç½®             |
| -------------- | ----------------------- | ---------------- | -------------------- |
| **é€æ˜é”™è¯¯**   | `#[error(transparent)]` | ä¿ç•™åŸå§‹é”™è¯¯ä¿¡æ¯ | `error.rs` (4-29è¡Œ)  |
| **è‡ªåŠ¨è½¬æ¢**   | `#[from]` è‡ªåŠ¨è½¬æ¢      | ç®€åŒ–é”™è¯¯ä¼ æ’­     | `error.rs`           |
| **åºåˆ—åŒ–æ”¯æŒ** | `impl Serialize`        | ä¼ é€’åˆ°å‰ç«¯       | `error.rs` (33-40è¡Œ) |
| **ç±»å‹å®‰å…¨**   | æšä¸¾ç±»å‹                | ç¼–è¯‘æ—¶æ£€æŸ¥       | `error.rs` (3è¡Œ)     |

---

## ğŸ“ æ€»ç»“ä¸å­¦ä¹ è·¯å¾„å»ºè®®ï¼ˆç»­ï¼‰

### å®Œæ•´å­¦ä¹ è·¯å¾„

**ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¶æ„ï¼ˆWeek 1-2ï¼‰**

1. âœ… **Tauri é¡¹ç›®æ­å»º**
   - é…ç½® `tauri.conf.json` å®‰å…¨æƒé™
   - ç†è§£ `Cargo.toml` ä¾èµ–ç®¡ç†
   - æŒæ¡ `vite.config.js` æ„å»ºé…ç½®

2. âœ… **é…ç½®ç®¡ç†ç³»ç»Ÿ**
   - å­¦ä¹  `tauri-plugin-store` ä½¿ç”¨
   - å®ç° `useConfig` Hook
   - ç†è§£äº‹ä»¶é©±åŠ¨é…ç½®åŒæ­¥

3. âœ… **é”™è¯¯å¤„ç†**
   - è®¾è®¡ç»Ÿä¸€é”™è¯¯ç±»å‹
   - ä½¿ç”¨ `thiserror` crate
   - é”™è¯¯ä¼ é€’åˆ°å‰ç«¯

**ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆWeek 3-4ï¼‰**

4. âœ… **çª—å£ç®¡ç†**
   - å¤šæ˜¾ç¤ºå™¨æ”¯æŒ
   - çª—å£å¤ç”¨æœºåˆ¶
   - å¹³å°å·®å¼‚åŒ–å¤„ç†

5. âœ… **WebDAV å®¢æˆ·ç«¯**
   - å®ç°åŸºæœ¬æ“ä½œï¼ˆlist, get, put, deleteï¼‰
   - é”™è¯¯å¤„ç†ä¸é‡è¯•
   - è®¤è¯ç®¡ç†

6. âœ… **æ–‡ä»¶ç›‘æ§**
   - æ–‡ä»¶å˜æ›´æ£€æµ‹
   - é˜²æŠ–ä¼˜åŒ–
   - å¢é‡åŒæ­¥ç®—æ³•

**ç¬¬ä¸‰é˜¶æ®µï¼šç³»ç»Ÿé›†æˆï¼ˆWeek 5-6ï¼‰**

7. âœ… **ç³»ç»Ÿæ‰˜ç›˜**
   - æ‰˜ç›˜èœå•è®¾è®¡
   - å¤šè¯­è¨€æ”¯æŒ
   - äº‹ä»¶å¤„ç†

8. âœ… **å…¨å±€å¿«æ·é”®**
   - å¿«æ·é”®æ³¨å†Œ
   - åŠ¨æ€é…ç½®
   - å†²çªå¤„ç†

9. âœ… **HTTP æœåŠ¡å™¨**
   - æœ¬åœ°æœåŠ¡å™¨å®ç°
   - è·¯ç”±è®¾è®¡
   - å¤–éƒ¨è°ƒç”¨æ¥å£

**ç¬¬å››é˜¶æ®µï¼šä¼˜åŒ–ä¸æ‰©å±•ï¼ˆWeek 7-8ï¼‰**

10. âœ… **æ€§èƒ½ä¼˜åŒ–**
    - é˜²æŠ–ä¸èŠ‚æµ
    - å†…å­˜ç®¡ç†
    - å»¶è¿Ÿåˆå§‹åŒ–

11. âœ… **æ’ä»¶ç³»ç»Ÿ**
    - æ’ä»¶åŠ è½½æœºåˆ¶
    - æ’ä»¶éªŒè¯
    - åŠ¨æ€æ‰§è¡Œ

12. âœ… **å¹³å°é€‚é…**
    - æ¡ä»¶ç¼–è¯‘
    - å¹³å°ç‰¹å®šä»£ç 
    - è·¨å¹³å°æµ‹è¯•

### å…³é”®æŠ€æœ¯ç‚¹ä¼˜å…ˆçº§

**ğŸ”´ P0 - å¿…é¡»æŒæ¡ï¼ˆLightSync é¡¹ç›®æ ¸å¿ƒï¼‰ï¼š**

| æŠ€æœ¯ç‚¹            | å­¦ä¹ æ—¶é—´ | å…³é”®æ–‡ä»¶                     | åº”ç”¨åœºæ™¯     |
| ----------------- | -------- | ---------------------------- | ------------ |
| **Tauri é…ç½®**    | 1å¤©      | `tauri.conf.json`            | å®‰å…¨æƒé™é…ç½® |
| **é…ç½®ç®¡ç†**      | 2å¤©      | `config.rs`, `useConfig.jsx` | ç”¨æˆ·è®¾ç½®ä¿å­˜ |
| **WebDAV å®¢æˆ·ç«¯** | 3å¤©      | `backup.rs`                  | æ–‡ä»¶åŒæ­¥æ ¸å¿ƒ |
| **é”™è¯¯å¤„ç†**      | 1å¤©      | `error.rs`                   | ç¨³å®šæ€§ä¿éšœ   |
| **çª—å£ç®¡ç†**      | 2å¤©      | `window.rs`                  | ç”¨æˆ·ä½“éªŒ     |

**ğŸŸ¡ P1 - æ¨èå­¦ä¹ ï¼ˆæå‡é¡¹ç›®è´¨é‡ï¼‰ï¼š**

| æŠ€æœ¯ç‚¹       | å­¦ä¹ æ—¶é—´ | å…³é”®æ–‡ä»¶           | åº”ç”¨åœºæ™¯ |
| ------------ | -------- | ------------------ | -------- |
| **æ–‡ä»¶ç›‘æ§** | 2å¤©      | `store.js` (watch) | å®æ—¶åŒæ­¥ |
| **é˜²æŠ–ä¼˜åŒ–** | 1å¤©      | `utils/index.js`   | æ€§èƒ½ä¼˜åŒ– |
| **äº‹ä»¶ç³»ç»Ÿ** | 1å¤©      | `useConfig.jsx`    | çŠ¶æ€åŒæ­¥ |
| **ç³»ç»Ÿæ‰˜ç›˜** | 2å¤©      | `tray.rs`          | åå°è¿è¡Œ |

**âšª P2 - è¿›é˜¶å­¦ä¹ ï¼ˆæ‰©å±•åŠŸèƒ½ï¼‰ï¼š**

| æŠ€æœ¯ç‚¹           | å­¦ä¹ æ—¶é—´ | å…³é”®æ–‡ä»¶        | åº”ç”¨åœºæ™¯   |
| ---------------- | -------- | --------------- | ---------- |
| **æ’ä»¶ç³»ç»Ÿ**     | 3å¤©      | `cmd.rs`        | åŠŸèƒ½æ‰©å±•   |
| **HTTP æœåŠ¡å™¨**  | 2å¤©      | `server.rs`     | å¤–éƒ¨æ¥å£   |
| **å¹³å°ç‰¹å®šä»£ç ** | 2å¤©      | `system_ocr.rs` | è·¨å¹³å°å…¼å®¹ |

---

## ğŸ“š å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£

| èµ„æº           | é“¾æ¥                                | ç”¨é€”     |
| -------------- | ----------------------------------- | -------- |
| **Tauri æ–‡æ¡£** | https://tauri.app/v1/guides/        | æ¡†æ¶å­¦ä¹  |
| **Rust Book**  | https://doc.rust-lang.org/book/     | è¯­è¨€åŸºç¡€ |
| **React æ–‡æ¡£** | https://react.dev/                  | å‰ç«¯æ¡†æ¶ |
| **WebDAV RFC** | https://tools.ietf.org/html/rfc4918 | åè®®æ ‡å‡† |

### å…³é”®ä¾èµ–

| ä¾èµ–                   | ç‰ˆæœ¬  | ç”¨é€”          | æ–‡æ¡£                                            |
| ---------------------- | ----- | ------------- | ----------------------------------------------- |
| **tauri**              | 1.8   | æ¡†æ¶æ ¸å¿ƒ      | https://docs.rs/tauri/                          |
| **reqwest-dav**        | 0.1.5 | WebDAV å®¢æˆ·ç«¯ | https://docs.rs/reqwest-dav/                    |
| **tauri-plugin-store** | v1    | é…ç½®å­˜å‚¨      | https://github.com/tauri-apps/plugins-workspace |
| **thiserror**          | 1.0   | é”™è¯¯å¤„ç†      | https://docs.rs/thiserror/                      |

---

## âœ… æ£€æŸ¥æ¸…å•

### å¼€å‘å‰å‡†å¤‡

- [ ] é˜…è¯» Tauri å®˜æ–¹æ–‡æ¡£
- [ ] æŒæ¡ Rust åŸºç¡€è¯­æ³•
- [ ] ç†Ÿæ‚‰ React Hooks
- [ ] ç†è§£ WebDAV åè®®

### å¼€å‘è¿‡ç¨‹

- [ ] é…ç½® Tauri å®‰å…¨æƒé™
- [ ] å®ç°é…ç½®ç®¡ç†ç³»ç»Ÿ
- [ ] è®¾è®¡é”™è¯¯å¤„ç†æœºåˆ¶
- [ ] å®ç° WebDAV å®¢æˆ·ç«¯
- [ ] æ·»åŠ æ–‡ä»¶ç›‘æ§åŠŸèƒ½
- [ ] ä¼˜åŒ–æ€§èƒ½ï¼ˆé˜²æŠ–ã€èŠ‚æµï¼‰
- [ ] å®ç°ç³»ç»Ÿæ‰˜ç›˜
- [ ] æ·»åŠ å…¨å±€å¿«æ·é”®

### æµ‹è¯•ä¸ä¼˜åŒ–

- [ ] å•å…ƒæµ‹è¯•è¦†ç›–
- [ ] é›†æˆæµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] è·¨å¹³å°æµ‹è¯•
- [ ] ç”¨æˆ·ä½“éªŒæµ‹è¯•

---
