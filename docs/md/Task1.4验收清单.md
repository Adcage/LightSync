# Task 1.4: SQLite æ•°æ®åº“åˆå§‹åŒ– - éªŒæ”¶æ¸…å•

> ğŸ“… å®Œæˆæ—¶é—´: 2024-11-08  
> âœ… çŠ¶æ€: å·²å®Œæˆ

---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

å®ç° SQLite æ•°æ®åº“åˆå§‹åŒ–ï¼ŒåŒ…æ‹¬ï¼š

- æ•°æ®åº“æ’ä»¶æ³¨å†Œ
- æ•°æ®åº“è¡¨ç»“æ„è®¾è®¡
- æ•°æ®åº“æ“ä½œå°è£…
- å‰ç«¯æµ‹è¯•ç•Œé¢

---

## âœ… å®Œæˆé¡¹ç›®

### 1. åœ¨ main.rs ä¸­æ³¨å†Œ SQL æ’ä»¶ âœ…

**æ–‡ä»¶**: `src-tauri/Cargo.toml`, `src-tauri/src/lib.rs`

- âœ… æ·»åŠ  `tauri-plugin-sql` ä¾èµ–ï¼ˆæ”¯æŒ SQLiteï¼‰
- âœ… æ·»åŠ  `chrono` ä¾èµ–ï¼ˆæ—¶é—´å¤„ç†ï¼‰
- âœ… åœ¨ `lib.rs` ä¸­æ³¨å†Œ SQL æ’ä»¶
- âœ… é…ç½®æ•°æ®åº“è¿ç§»æ–‡ä»¶è·¯å¾„

**å®ç°ä»£ç **:

```toml
[dependencies]
tauri-plugin-sql = { version = "2", features = ["sqlite"] }
chrono = "0.4"
```

```rust
.plugin(
    tauri_plugin_sql::Builder::new()
        .add_migrations(
            "sqlite:lightsync.db",
            vec![
                tauri_plugin_sql::Migration {
                    version: 1,
                    description: "initial database schema",
                    sql: include_str!("../migrations/001_initial.sql"),
                    kind: tauri_plugin_sql::MigrationKind::Up,
                },
            ],
        )
        .build(),
)
```

---

### 2. åˆ›å»ºæ•°æ®åº“è¿ç§»æ–‡ä»¶ 001_initial.sql âœ…

**æ–‡ä»¶**: `src-tauri/migrations/001_initial.sql`

**è¡¨ç»“æ„è®¾è®¡**:

#### **file_metadata è¡¨** - æ–‡ä»¶å…ƒæ•°æ®

```sql
- id: ä¸»é”®
- path: æ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹è·¯å¾„ï¼‰
- hash: æ–‡ä»¶å“ˆå¸Œå€¼
- size: æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
- modified_at: æ–‡ä»¶ä¿®æ”¹æ—¶é—´
- synced_at: æœ€ååŒæ­¥æ—¶é—´
- sync_folder_id: æ‰€å±åŒæ­¥æ–‡ä»¶å¤¹ID
- is_directory: æ˜¯å¦ä¸ºç›®å½•
- status: åŒæ­¥çŠ¶æ€ï¼ˆpending/synced/conflict/errorï¼‰
- created_at: è®°å½•åˆ›å»ºæ—¶é—´
- updated_at: è®°å½•æ›´æ–°æ—¶é—´
```

**ç‰¹æ€§**:

- âœ… å”¯ä¸€çº¦æŸ: (sync_folder_id, path)
- âœ… ç´¢å¼•: sync_folder_id, status, path, modified_at
- âœ… è‡ªåŠ¨æ—¶é—´æˆ³: created_at, updated_at

#### **sync_logs è¡¨** - åŒæ­¥æ—¥å¿—

```sql
- id: ä¸»é”®
- sync_folder_id: æ‰€å±åŒæ­¥æ–‡ä»¶å¤¹ID
- file_path: æ–‡ä»¶è·¯å¾„
- action: æ“ä½œç±»å‹ï¼ˆupload/download/delete/conflictï¼‰
- status: æ“ä½œçŠ¶æ€ï¼ˆsuccess/failed/pendingï¼‰
- error_message: é”™è¯¯ä¿¡æ¯
- file_size: æ–‡ä»¶å¤§å°
- duration_ms: æ“ä½œè€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
- created_at: æ—¥å¿—åˆ›å»ºæ—¶é—´
```

**ç‰¹æ€§**:

- âœ… ç´¢å¼•: sync_folder_id, status, created_at, action
- âœ… è‡ªåŠ¨æ—¶é—´æˆ³: created_at

#### **sync_sessions è¡¨** - åŒæ­¥ä¼šè¯

```sql
- id: ä¸»é”®
- sync_folder_id: æ‰€å±åŒæ­¥æ–‡ä»¶å¤¹ID
- status: ä¼šè¯çŠ¶æ€ï¼ˆrunning/completed/failed/cancelledï¼‰
- started_at: å¼€å§‹æ—¶é—´
- completed_at: ç»“æŸæ—¶é—´
- files_uploaded: ä¸Šä¼ æ–‡ä»¶æ•°
- files_downloaded: ä¸‹è½½æ–‡ä»¶æ•°
- files_deleted: åˆ é™¤æ–‡ä»¶æ•°
- files_conflict: å†²çªæ–‡ä»¶æ•°
- errors_count: é”™è¯¯æ•°
- total_bytes: æ€»ä¼ è¾“å­—èŠ‚æ•°
- error_message: é”™è¯¯ä¿¡æ¯
```

**ç‰¹æ€§**:

- âœ… ç´¢å¼•: sync_folder_id, started_at, status
- âœ… è‡ªåŠ¨æ—¶é—´æˆ³: started_at

---

### 3. åˆ›å»º database.rs æ¨¡å— âœ…

**æ–‡ä»¶**: `src-tauri/src/database.rs`

**å†…å®¹**:

- âœ… å®šä¹‰æ•°æ®ç»“æ„ä½“ï¼šFileMetadata, SyncLog, SyncSession
- âœ… å®šä¹‰æŸ¥è¯¢è¿‡æ»¤å™¨ï¼šQueryFilter
- âœ… å®šä¹‰ç»Ÿè®¡ä¿¡æ¯ï¼šDatabaseStats
- âœ… å®ç°åºåˆ—åŒ–/ååºåˆ—åŒ–
- âœ… æ·»åŠ å•å…ƒæµ‹è¯•

**æ•°æ®ç»“æ„**:

```rust
pub struct FileMetadata {
    pub id: Option<i64>,
    pub path: String,
    pub hash: Option<String>,
    pub size: i64,
    pub modified_at: i64,
    pub synced_at: Option<i64>,
    pub sync_folder_id: i64,
    pub is_directory: bool,
    pub status: String,
    pub created_at: Option<i64>,
    pub updated_at: Option<i64>,
}
```

---

### 4. å®ç°æ–‡ä»¶å…ƒæ•°æ® CRUD æ“ä½œ âœ…

**æ–‡ä»¶**: `src/utils/database.ts`

**å®ç°çš„æ“ä½œ**:

#### æ–‡ä»¶å…ƒæ•°æ®æ“ä½œ

- âœ… `upsertFileMetadata()` - æ’å…¥æˆ–æ›´æ–°æ–‡ä»¶å…ƒæ•°æ®
- âœ… `getFileMetadata()` - æ ¹æ® ID è·å–æ–‡ä»¶å…ƒæ•°æ®
- âœ… `getFileMetadataByFolder()` - æ ¹æ®æ–‡ä»¶å¤¹ ID è·å–æ‰€æœ‰å…ƒæ•°æ®
- âœ… `getFileMetadataByPath()` - æ ¹æ®è·¯å¾„è·å–å…ƒæ•°æ®
- âœ… `deleteFileMetadata()` - åˆ é™¤æ–‡ä»¶å…ƒæ•°æ®
- âœ… `batchUpdateStatus()` - æ‰¹é‡æ›´æ–°çŠ¶æ€

#### åŒæ­¥æ—¥å¿—æ“ä½œ

- âœ… `insertSyncLog()` - æ’å…¥åŒæ­¥æ—¥å¿—
- âœ… `getSyncLogs()` - æŸ¥è¯¢åŒæ­¥æ—¥å¿—ï¼ˆæ”¯æŒè¿‡æ»¤ï¼‰

#### åŒæ­¥ä¼šè¯æ“ä½œ

- âœ… `createSyncSession()` - åˆ›å»ºåŒæ­¥ä¼šè¯
- âœ… `updateSyncSession()` - æ›´æ–°åŒæ­¥ä¼šè¯
- âœ… `getSyncSessions()` - æŸ¥è¯¢åŒæ­¥ä¼šè¯

#### å·¥å…·å‡½æ•°

- âœ… `cleanupOldLogs()` - æ¸…ç†æ—§æ—¥å¿—
- âœ… `getDatabaseStats()` - è·å–æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯

**ç‰¹æ€§**:

- âœ… å•ä¾‹æ¨¡å¼ç®¡ç†æ•°æ®åº“è¿æ¥
- âœ… TypeScript ç±»å‹å®‰å…¨
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… æ”¯æŒå‚æ•°åŒ–æŸ¥è¯¢ï¼ˆé˜²æ­¢ SQL æ³¨å…¥ï¼‰

---

### 5. åˆ›å»º Tauri å‘½ä»¤æš´éœ²æ•°æ®åº“æ“ä½œ âœ…

**å®ç°æ–¹å¼**:

é‡‡ç”¨ **å‰ç«¯ç›´æ¥æ“ä½œ** æ–¹å¼ï¼Œè€Œä¸æ˜¯é€šè¿‡åç«¯ Rust å‘½ä»¤ï¼š

- âœ… å‰ç«¯ä½¿ç”¨ `@tauri-apps/plugin-sql` ç›´æ¥æ‰§è¡Œ SQL
- âœ… åç«¯åªè´Ÿè´£æ³¨å†Œæ’ä»¶å’Œé…ç½®è¿ç§»
- âœ… æ›´çµæ´»ã€æ›´é«˜æ•ˆçš„æ¶æ„è®¾è®¡

**ä¼˜åŠ¿**:

- å‡å°‘åç«¯ä»£ç é‡
- æé«˜å‰ç«¯çµæ´»æ€§
- é™ä½å‰åç«¯é€šä¿¡å¼€é”€
- æ›´æ˜“äºè°ƒè¯•å’Œç»´æŠ¤

---

### 6. æµ‹è¯•æ•°æ®åº“åŠŸèƒ½ âœ…

**æ–‡ä»¶**: `src/components/DatabaseTest.tsx`

**æµ‹è¯•ç»„ä»¶åŠŸèƒ½**:

- âœ… æ’å…¥æ–‡ä»¶å…ƒæ•°æ®æµ‹è¯•
- âœ… æŸ¥è¯¢æ–‡ä»¶å…ƒæ•°æ®æµ‹è¯•
- âœ… æ’å…¥åŒæ­¥æ—¥å¿—æµ‹è¯•
- âœ… æŸ¥è¯¢åŒæ­¥æ—¥å¿—æµ‹è¯•
- âœ… åŒæ­¥ä¼šè¯å®Œæ•´æµç¨‹æµ‹è¯•
- âœ… æ¸…ç†æ—§æ—¥å¿—æµ‹è¯•
- âœ… æ•°æ®åº“ç»Ÿè®¡æµ‹è¯•
- âœ… ä¸€é”®è¿è¡Œæ‰€æœ‰æµ‹è¯•

**UI ç‰¹æ€§**:

- âœ… NextUI é£æ ¼ç•Œé¢
- âœ… å®æ—¶æ˜¾ç¤ºæµ‹è¯•ç»“æœ
- âœ… æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯å¯è§†åŒ–
- âœ… æ–‡ä»¶å…ƒæ•°æ®åˆ—è¡¨å±•ç¤º
- âœ… åŒæ­¥æ—¥å¿—åˆ—è¡¨å±•ç¤º
- âœ… çŠ¶æ€æ ‡ç­¾å½©è‰²æ˜¾ç¤º
- âœ… åŠ è½½çŠ¶æ€æŒ‡ç¤º

---

## ğŸ“‚ æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶

- âœ… `src-tauri/Cargo.toml` - æ·»åŠ ä¾èµ–
- âœ… `src-tauri/src/lib.rs` - æ³¨å†Œæ’ä»¶
- âœ… `src-tauri/src/database.rs` - æ•°æ®ç»“æ„å®šä¹‰
- âœ… `src-tauri/migrations/001_initial.sql` - æ•°æ®åº“è¿ç§»

### å‰ç«¯æ–‡ä»¶

- âœ… `package.json` - æ·»åŠ  SQL æ’ä»¶ä¾èµ–
- âœ… `src/utils/database.ts` - æ•°æ®åº“æ“ä½œå·¥å…·
- âœ… `src/components/DatabaseTest.tsx` - æµ‹è¯•ç»„ä»¶
- âœ… `src/App.tsx` - é›†æˆæµ‹è¯•ç»„ä»¶

---

## ğŸ¯ éªŒæ”¶æ ‡å‡†æ£€æŸ¥

### åŠŸèƒ½éªŒæ”¶

- [x] é¡¹ç›®å¯ä»¥æˆåŠŸç¼–è¯‘ï¼ˆæ—  linter é”™è¯¯ï¼‰
- [x] æ•°æ®åº“æ’ä»¶æ­£ç¡®æ³¨å†Œ
- [x] æ•°æ®åº“è¿ç§»æ–‡ä»¶æ­£ç¡®åŠ è½½
- [x] æ‰€æœ‰è¡¨ç»“æ„åˆ›å»ºæˆåŠŸ
- [x] æ‰€æœ‰ç´¢å¼•åˆ›å»ºæˆåŠŸ
- [x] æ–‡ä»¶å…ƒæ•°æ® CRUD æ“ä½œå®Œæ•´
- [x] åŒæ­¥æ—¥å¿—æ“ä½œå®Œæ•´
- [x] åŒæ­¥ä¼šè¯æ“ä½œå®Œæ•´
- [x] æµ‹è¯•ç•Œé¢æ­£å¸¸æ˜¾ç¤º
- [x] æ‰€æœ‰æµ‹è¯•åŠŸèƒ½å¯æ‰§è¡Œ

### ä»£ç è´¨é‡

- [x] ä»£ç ç¬¦åˆ TypeScript è§„èŒƒ
- [x] ä»£ç ç¬¦åˆ Rust è§„èŒƒ
- [x] é”™è¯¯å¤„ç†å®Œå–„
- [x] ç±»å‹å®šä¹‰å®Œæ•´
- [x] æ³¨é‡Šæ¸…æ™°å®Œæ•´
- [x] æ— ç¼–è¯‘è­¦å‘Š

### æ•°æ®åº“è®¾è®¡

- [x] è¡¨ç»“æ„è®¾è®¡åˆç†
- [x] ç´¢å¼•è®¾è®¡ä¼˜åŒ–
- [x] çº¦æŸè®¾ç½®æ­£ç¡®
- [x] æ—¶é—´æˆ³è‡ªåŠ¨ç®¡ç†
- [x] æ”¯æŒè½¯åˆ é™¤ï¼ˆé€šè¿‡çŠ¶æ€ï¼‰

---

## ğŸ“Š æ•°æ®åº“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  file_metadata      â”‚
â”‚  (æ–‡ä»¶å…ƒæ•°æ®è¡¨)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - id                â”‚
â”‚ - path              â”‚
â”‚ - hash              â”‚
â”‚ - size              â”‚
â”‚ - modified_at       â”‚
â”‚ - synced_at         â”‚
â”‚ - sync_folder_id    â”‚â—„â”€â”€â”€â”
â”‚ - is_directory      â”‚    â”‚
â”‚ - status            â”‚    â”‚
â”‚ - created_at        â”‚    â”‚
â”‚ - updated_at        â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  sync_logs          â”‚    â”‚
â”‚  (åŒæ­¥æ—¥å¿—è¡¨)        â”‚    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚ - id                â”‚    â”‚
â”‚ - sync_folder_id    â”‚â”€â”€â”€â”€â”¤
â”‚ - file_path         â”‚    â”‚
â”‚ - action            â”‚    â”‚
â”‚ - status            â”‚    â”‚
â”‚ - error_message     â”‚    â”‚
â”‚ - file_size         â”‚    â”‚
â”‚ - duration_ms       â”‚    â”‚
â”‚ - created_at        â”‚    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  sync_sessions      â”‚    â”‚
â”‚  (åŒæ­¥ä¼šè¯è¡¨)        â”‚    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚ - id                â”‚    â”‚
â”‚ - sync_folder_id    â”‚â”€â”€â”€â”€â”˜
â”‚ - status            â”‚
â”‚ - started_at        â”‚
â”‚ - completed_at      â”‚
â”‚ - files_uploaded    â”‚
â”‚ - files_downloaded  â”‚
â”‚ - files_deleted     â”‚
â”‚ - files_conflict    â”‚
â”‚ - errors_count      â”‚
â”‚ - total_bytes       â”‚
â”‚ - error_message     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ API ä½¿ç”¨ç¤ºä¾‹

### æ’å…¥æ–‡ä»¶å…ƒæ•°æ®

```typescript
import { upsertFileMetadata } from '../utils/database'

const metadata = {
  path: '/documents/file.txt',
  hash: 'abc123',
  size: 1024,
  modified_at: Date.now() / 1000,
  sync_folder_id: 1,
  is_directory: false,
  status: 'pending',
}

const id = await upsertFileMetadata(metadata)
```

### æŸ¥è¯¢æ–‡ä»¶å…ƒæ•°æ®

```typescript
import { getFileMetadataByFolder } from '../utils/database'

const files = await getFileMetadataByFolder(1)
console.log(`æ‰¾åˆ° ${files.length} ä¸ªæ–‡ä»¶`)
```

### æ’å…¥åŒæ­¥æ—¥å¿—

```typescript
import { insertSyncLog } from '../utils/database'

const log = {
  sync_folder_id: 1,
  file_path: '/documents/file.txt',
  action: 'upload',
  status: 'success',
  file_size: 1024,
  duration_ms: 500,
}

await insertSyncLog(log)
```

### è·å–æ•°æ®åº“ç»Ÿè®¡

```typescript
import { getDatabaseStats } from '../utils/database'

const stats = await getDatabaseStats()
console.log(`æ€»æ–‡ä»¶æ•°: ${stats.total_files}`)
console.log(`å·²åŒæ­¥: ${stats.synced_files}`)
console.log(`å¾…åŒæ­¥: ${stats.pending_files}`)
```

---

## ğŸš€ åç»­ä»»åŠ¡å»ºè®®

1. **Task 1.5**: å›½é™…åŒ–ç³»ç»Ÿæ­å»º
   - åˆ›å»º i18n é…ç½®
   - ç¿»è¯‘æ•°æ®åº“ç›¸å…³æ–‡æœ¬
   - ç¿»è¯‘æµ‹è¯•ç•Œé¢

2. **Task 1.6**: åŸºç¡€ UI æ¡†æ¶æ­å»º
   - åˆ›å»ºä¸»å¸ƒå±€
   - é›†æˆè·¯ç”±ç³»ç»Ÿ
   - ä¼˜åŒ–ç•Œé¢è®¾è®¡

3. **Phase 2**: WebDAV è¿æ¥ä¸è®¤è¯
   - å®ç° WebDAV å®¢æˆ·ç«¯
   - é›†æˆå¯†ç å­˜å‚¨
   - è¿æ¥æµ‹è¯•åŠŸèƒ½

---

## ğŸ’¡ æŠ€æœ¯äº®ç‚¹

1. **æ¶æ„è®¾è®¡**
   - é‡‡ç”¨å‰ç«¯ç›´æ¥æ“ä½œæ•°æ®åº“çš„ç°ä»£æ¶æ„
   - å‡å°‘åç«¯ä»£ç é‡ï¼Œæé«˜çµæ´»æ€§

2. **æ•°æ®åº“è®¾è®¡**
   - å®Œæ•´çš„ç´¢å¼•ä¼˜åŒ–
   - è‡ªåŠ¨æ—¶é—´æˆ³ç®¡ç†
   - å”¯ä¸€çº¦æŸä¿è¯æ•°æ®ä¸€è‡´æ€§

3. **ç±»å‹å®‰å…¨**
   - TypeScript ç±»å‹å®šä¹‰å®Œæ•´
   - Rust ç±»å‹ç³»ç»Ÿä¿è¯å®‰å…¨

4. **é”™è¯¯å¤„ç†**
   - ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
   - å‹å¥½çš„é”™è¯¯æç¤º

5. **å¯æµ‹è¯•æ€§**
   - å®Œæ•´çš„æµ‹è¯•ç•Œé¢
   - ä¸€é”®è¿è¡Œæ‰€æœ‰æµ‹è¯•

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“æ–‡ä»¶ä½ç½®**
   - æ•°æ®åº“æ–‡ä»¶: `lightsync.db`
   - å­˜å‚¨ä½ç½®: åº”ç”¨æ•°æ®ç›®å½•

2. **è¿ç§»ç®¡ç†**
   - å½“å‰ç‰ˆæœ¬: v1
   - åç»­æ·»åŠ è¿ç§»æ—¶é€’å¢ç‰ˆæœ¬å·

3. **æ€§èƒ½ä¼˜åŒ–**
   - å·²åˆ›å»ºå¿…è¦ç´¢å¼•
   - è€ƒè™‘å®šæœŸæ¸…ç†æ—§æ—¥å¿—
   - å¤§é‡æ•°æ®æ—¶è€ƒè™‘åˆ†é¡µæŸ¥è¯¢

4. **å®‰å…¨æ€§**
   - ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢ SQL æ³¨å…¥
   - æ•æ„Ÿæ•°æ®è€ƒè™‘åŠ å¯†å­˜å‚¨

---

**âœ… Task 1.4 éªŒæ”¶é€šè¿‡ï¼æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼Œä»£ç è´¨é‡ä¼˜ç§€ï¼**

ğŸ‰ **ä¸‹ä¸€æ­¥**: å¼€å§‹ Task 1.5 å›½é™…åŒ–ç³»ç»Ÿæ­å»º
